<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Archive</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #000;
      line-height: 1.5;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: -1;
    }
    .page {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      margin: 0;
      padding-bottom: 10px;
    }
    .top-menu {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .left-menu {
      display: flex;
      gap: 3px;
    }
    .right-menu {
      display: flex;
      gap: 3px;
    }
    .top-menu-btn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
    }
    .top-menu-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .top-menu-btn.mode-btn.selected {
      background: black;
      color: white;
      border-color: black;
    }
    
    /* ë…„ë„ í‘œì‹œ ìŠ¤íƒ€ì¼ */
    .year-display {
      font-size: 0.9rem;
      font-weight: 600;
      color: #000;
      min-width: 50px;
      text-align: center;
      padding: 0 5px;
      margin: 0 3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 30px;
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
      border-radius: 3px;
    }
    
    /* ë…„ë„ ë²„íŠ¼ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
    .year-btn {
      min-width: 30px;
      width: 30px;
      padding: 5px;
    }

    /* ì£¼ë¬¸ ëª©ë¡ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .order-table-container {
      margin-top: 20px;
      overflow-x: auto;
      width: 100%;
    }
    
    #orderTable {
      width: 100%;
      min-width: 800px;
      border-collapse: collapse;
      border: 1px solid #ccc;
    }
    
    #orderTable th,
    #orderTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }
    
    #orderTable th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    
    #orderTable td {
      font-size: 0.9rem;
    }
    
    /* í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ ì „ì²´ - order.htmlê³¼ ë™ì¼ */
    .bottom-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 15px;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    /* í™•ì¥ ì†ì¡ì´ (ì„œë ì†ì¡ì´ì²˜ëŸ¼ ìœ„ìª½ì— íŠ€ì–´ë‚˜ì˜´) */
    .expand-handle {
      position: absolute;
      top: -15px;
      left: 20px;
      z-index: 10;
    }

    /* í™•ì¥/ì¶•ì†Œ ë²„íŠ¼ */
    .expand-btn {
      font-size: 0.8rem;
      padding: 4px 12px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #f8f8f8;
      color: #666;
      border-radius: 8px 8px 0 0;
      min-width: 40px;
      height: 20px;
      line-height: 1;
      transition: all 0.2s ease;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
    }

    .expand-btn:hover {
      background: #e8e8e8;
      border-color: #999;
      box-shadow: 0 -3px 6px rgba(0,0,0,0.15);
    }

    .expand-btn.expanded {
      transform: rotate(180deg);
      background: #e0e0e0;
    }

    /* ê¸°ë³¸ ë²„íŠ¼ ê·¸ë£¹ ë ˆì´ì•„ì›ƒ */
    .main-button-group {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
      padding: 15px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }

    /* ìƒì„¸ ë²„íŠ¼ ì˜ì—­ */
    .detail-button-area {
      margin-top: 10px;
      padding: 12px;
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      animation: slideDown 0.3s ease;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .detail-button-area button {
      margin: 0;
    }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }


    /* í…Œì´ë¸” í•˜ë‹¨ ì—¬ë°± (ê³ ì • ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡) */
    .order-table-container {
      margin-bottom: 120px;
    }

    /* íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .preview-modal-content {
      background: white;
      border-radius: 10px;
      width: 95%;
      max-width: 1200px;
      height: 90%;
      display: flex;
      flex-direction: row;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
    .preview-sidebar {
      width: 250px;
      background: #f8f9fa;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      border-radius: 10px 0 0 10px;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #ddd;
      background: #e9ecef;
      border-radius: 10px 0 0 0;
    }

    .sidebar-title {
      margin: 0;
      font-size: 16px;
      color: #495057;
    }

    .file-list {
      height: 540px;
      overflow-y: auto;
      padding: 10px 0;
    }

    .file-item {
      padding: 8px 15px;
      cursor: pointer;
      border-bottom: 1px solid #e9ecef;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-item:hover {
      background-color: #e9ecef;
    }

    .file-item.active {
      background-color: #007bff;
      color: white;
    }

    .file-icon {
      font-size: 16px;
    }

    .file-name {
      flex: 1;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .delete-file-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background-color 0.2s;
      opacity: 0.7;
    }

    .delete-file-btn:hover {
      background-color: #dc3545;
      color: white;
      opacity: 1;
    }

    /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */
    .preview-main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #ddd;
      background: #f8f9fa;
    }

    .preview-header h3 {
      margin: 0;
      font-size: 16px;
      color: #333;
    }

    .close-btn {
      background: transparent;
      color: #333;
      border: none;
      border-radius: 0;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: #f8f9fa;
      color: #000;
    }

    .preview-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #ddd;
    }

    .nav-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .nav-btn:hover {
      background: #0056b3;
    }

    .nav-btn:disabled {
      background: #007bff;
      opacity: 0.5;
      cursor: not-allowed;
    }

    .download-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .download-btn:hover {
      background: #218838;
    }

    #fileCounter {
      font-weight: bold;
      color: #333;
    }

    .preview-body {
      flex: 1;
      padding: 20px;
      overflow: auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .preview-iframe-container {
      width: 100%;
      max-width: 800px;
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .preview-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .preview-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-top: 1px solid #ddd;
      background: #f8f9fa;
      border-radius: 0 0 10px 10px;
    }

  </style>
</head>
<body>
<div class="page">
  <h1>Order Archive</h1>

  <div class="top-menu">
    <!-- ì™¼ìª½: Home, Year -->
    <div class="left-menu">
      <button type="button" onclick="location.href='eltrokorea9.html'" class="top-menu-btn">Home</button>
      
      <!-- ë…„ë„ ì„ íƒ ë²„íŠ¼ -->
      <button type="button" id="yearDownBtn" class="top-menu-btn year-btn">â–¼</button>
      <span id="yearDisplay" class="year-display">2024</span>
      <button type="button" id="yearUpBtn" class="top-menu-btn year-btn">â–²</button>
    </div>
    <!-- ì˜¤ë¥¸ìª½: NT, SM -->
    <div class="right-menu">
      <button id="ntBtn" class="top-menu-btn mode-btn selected">NT</button>
      <button id="smBtn" class="top-menu-btn mode-btn">SM</button>
    </div>
  </div>

  <div class="order-table-container">
    <table id="orderTable">
      <thead>
        <tr>
          <th>Order No</th>
          <th>Final Date</th>
          <th>Order ID</th>
          <th>Order Date</th>
          <th>ë°œì£¼ì„œ</th>
          <th>Email</th>
          <th>ì£¼ë¬¸ì„œ</th>
        </tr>
      </thead>
      <tbody id="orderTableBody">
        <!-- ì£¼ë¬¸ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </tbody>
    </table>
  </div>
</div>

<!-- íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div id="previewModal" class="preview-modal" style="display: none;">
  <div class="preview-modal-content">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <div class="preview-sidebar">
      <div class="sidebar-header">
        <h3 class="sidebar-title">ğŸ“ íŒŒì¼ ëª©ë¡</h3>
        <div></div>
      </div>
      <div class="file-list" id="fileList">
        <!-- íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>
    </div>
    
    <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    <div class="preview-main">
      <div class="preview-header">
        <h3 id="previewTitle">íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°</h3>
        <button id="closePreviewBtn" class="close-btn">&times;</button>
      </div>
      <div class="preview-navigation">
        <button id="prevFileBtn" class="nav-btn">â¬…ï¸ ì´ì „</button>
        <span id="fileCounter">1 / 1</span>
        <button id="nextFileBtn" class="nav-btn">ë‹¤ìŒ â¡ï¸</button>
      </div>
      <div class="preview-body">
        <div class="preview-iframe-container">
          <iframe id="previewFrame" class="preview-iframe" src="" frameborder="0"></iframe>
        </div>
      </div>
      <div class="preview-footer">
        <div></div>
        <button id="downloadCurrentBtn" class="download-btn">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>
  </div>
</div>

<!-- í•˜ë‹¨ ë²„íŠ¼ ì˜ì—­ - order.htmlê³¼ ë™ì¼í•œ êµ¬ì¡° -->
<div class="bottom-buttons">
  <!-- í™•ì¥/ì¶•ì†Œ ë²„íŠ¼ (ì„œë ì†ì¡ì´ì²˜ëŸ¼ ìœ„ìª½ì— íŠ€ì–´ë‚˜ì˜´) -->
  <div class="expand-handle">
    <button id="expandButton" type="button" class="expand-btn">â–¼</button>
  </div>
  
  <!-- ê¸°ë³¸ ë²„íŠ¼ ì˜ì—­ (í•­ìƒ ë³´ì„) -->
  <div class="main-button-group">
  </div>

  <!-- í™•ì¥ ê°€ëŠ¥í•œ ìƒì„¸ ë²„íŠ¼ ì˜ì—­ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
  <div id="detailButtonArea" class="detail-button-area" style="display: none;">
    <!-- í•„ìš”ì‹œ ì¶”ê°€ ë²„íŠ¼ë“¤ -->
  </div>
</div>

<script>
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ëª¨ë“œì™€ ë…„ë„ ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const urlMode = urlParams.get('mode');
        const urlYear = urlParams.get('year');

        // ëª¨ë“œ ì„ íƒ ë²„íŠ¼ (NT, SM)
        let selectedMode = urlMode === 'SM' ? 'SM' : "NT"; // NT ê¸°ë³¸
        let currentMode = selectedMode; // ë‚´ë¶€ ë¡œì§ìš©

        const ntBtn = document.getElementById("ntBtn");
        const smBtn = document.getElementById("smBtn");

        ntBtn.addEventListener("click", () => {
            selectedMode = "NT";
            currentMode = "NT";
            ntBtn.classList.add("selected");
            smBtn.classList.remove("selected");
            loadOrderData();
        });
        smBtn.addEventListener("click", () => {
            selectedMode = "SM";
            currentMode = "SM";
            smBtn.classList.add("selected");
            ntBtn.classList.remove("selected");
            loadOrderData();
        });
        // ë…„ë„ ì„ íƒ ì´ˆê¸°í™”
        let currentYear = urlYear ? parseInt(urlYear) : new Date().getFullYear();

        const yearDisplay = document.getElementById("yearDisplay");
        const yearUpBtn = document.getElementById("yearUpBtn");
        const yearDownBtn = document.getElementById("yearDownBtn");

        yearDisplay.textContent = currentYear;

        // ë…„ë„ ì¦ê°€ ë²„íŠ¼
        yearUpBtn.addEventListener("click", () => {
            currentYear++;
            yearDisplay.textContent = currentYear;
            loadOrderData(); // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        });

        // ë…„ë„ ê°ì†Œ ë²„íŠ¼
        yearDownBtn.addEventListener("click", () => {
            if (currentYear > 2020) {
                currentYear--;
                yearDisplay.textContent = currentYear;
                loadOrderData(); // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            }
        });
        // ì„œë²„ì—ì„œ ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ë° í‘œì‹œ
        async function loadOrderData() {
            try {
                        // ì„œë²„ APIë¥¼ í†µí•´ ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch('/api/orders');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                        const allOrders = await response.json();
                        // í˜„ì¬ ëª¨ë“œì™€ ë…„ë„ì— ë§ëŠ” ì£¼ë¬¸ í•„í„°ë§
                const filteredOrders = allOrders.filter(order => {
                                // ëª¨ë“œ í•„í„°ë§
                    if (currentMode === 'NT') {
                        if (order.mode !== 'NT') return false;
                    } else if (currentMode === 'SM') {
                        if (!(order.mode === 'SM-B' || order.mode === 'SM-C')) return false;
                    }
                                // ë…„ë„ í•„í„°ë§ (orderDateì—ì„œ ë…„ë„ ì¶”ì¶œ)
                    if (order.orderDate) {
                        const orderYear = extractYearFromDate(order.orderDate);
                        return orderYear === currentYear;
                    }
                    return false;
                });
                        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
                updateOrderTable(filteredOrders);
                    } catch (error) {
                console.error("[ORDER ARCHIVE] ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                updateOrderTable([]);
            }
        }
        // ë‚ ì§œì—ì„œ ë…„ë„ ì¶”ì¶œ í•¨ìˆ˜
        function extractYearFromDate(dateStr) {
                // "YYYY.MM.DD" í˜•ì‹ (orderData.jsonì—ì„œ ì‚¬ìš©)
            if (dateStr.includes('.')) {
                const parts = dateStr.split('.');
                if (parts.length >= 1) {
                    const year = parseInt(parts[0].trim());
                    return year;
                }
            }
                // "DD-MMM-YYYY" ë˜ëŠ” "DD. MMM. YYYY" í˜•ì‹
            const parts = dateStr.split(/[-.]/);
            if (parts.length >= 3) {
                const yearPart = parts[2].trim();
                const year = parseInt(yearPart);
                return year;
            }
            return null;
        }
        // ì£¼ë¬¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateOrderTable(orders) {
            const tbody = document.getElementById('orderTableBody');
            tbody.innerHTML = '';
                if (orders.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" style="text-align: center; color: #666;">í•´ë‹¹ ì¡°ê±´ì˜ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td>';
                tbody.appendChild(row);
                return;
            }
                // Order Date ìˆœìœ¼ë¡œ ì •ë ¬ (ì˜¤ë˜ëœ ê²ƒì´ ì•„ë˜ë¡œ)
            orders.sort((a, b) => {
                const getOrderDate = (orderDate) => {
                    if (!orderDate) return new Date(0); // nullì´ë‚˜ undefinedì¸ ê²½ìš° ê°€ì¥ ì˜¤ë˜ëœ ë‚ ì§œ
                    
                    // "YYYY.MM.DD" í˜•ì‹ íŒŒì‹±
                    if (orderDate.includes('.')) {
                        const parts = orderDate.split('.');
                        if (parts.length === 3) {
                            const year = parseInt(parts[0], 10);
                            const month = parseInt(parts[1], 10) - 1; // JavaScript DateëŠ” 0ë¶€í„° ì‹œì‘
                            const day = parseInt(parts[2], 10);
                            return new Date(year, month, day);
                        }
                    }
                    
                    // ë‹¤ë¥¸ í˜•ì‹ë„ ì‹œë„
                    return new Date(orderDate);
                };
                
                const dateA = getOrderDate(a.orderDate);
                const dateB = getOrderDate(b.orderDate);
                
                // ìµœì‹  ë‚ ì§œê°€ ìœ„ë¡œ ê°€ë„ë¡ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                return dateB - dateA;
            });
                orders.forEach(order => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.orderNo || 'N/A'}</td>
                    <td>${order.finalDate || 'N/A'}</td>
                    <td>${order.orderId || 'N/A'}</td>
                    <td>${order.orderDate || 'N/A'}</td>
                    <td>
                        <button class="top-menu-btn" onclick="uploadOrderSheet('${order.orderId}')" style="padding: 2px 4px; margin: 0 1px; border: 1px solid #ccc; border-radius: 2px; background: #fff; cursor: pointer; font-size: 10px; min-width: 20px; height: 20px; line-height: 1;" title="ë°œì£¼ì„œ ì—…ë¡œë“œ">ğŸ“¤</button>
                        <button class="top-menu-btn preview-btn" onclick="viewOrderSheet('${order.orderId}')" data-order-id="${order.orderId}" data-file-type="ë°œì£¼ì„œ" style="padding: 2px 4px; margin: 0 1px; border: 1px solid #ccc; border-radius: 2px; background: #fff; cursor: pointer; font-size: 10px; min-width: 20px; height: 20px; line-height: 1;" title="ë°œì£¼ì„œ ë³´ê¸°">ğŸ‘ï¸</button>
                    </td>
                    <td>
                        <button class="top-menu-btn" onclick="uploadEmail('${order.orderId}')" style="padding: 2px 4px; margin: 0 1px; border: 1px solid #ccc; border-radius: 2px; background: #fff; cursor: pointer; font-size: 10px; min-width: 20px; height: 20px; line-height: 1;" title="ì´ë©”ì¼ ì—…ë¡œë“œ">ğŸ“¤</button>
                        <button class="top-menu-btn preview-btn" onclick="viewEmail('${order.orderId}')" data-order-id="${order.orderId}" data-file-type="Email" style="padding: 2px 4px; margin: 0 1px; border: 1px solid #ccc; border-radius: 2px; background: #fff; cursor: pointer; font-size: 10px; min-width: 20px; height: 20px; line-height: 1;" title="ì´ë©”ì¼ ë³´ê¸°">ğŸ‘ï¸</button>
                    </td>
                    <td>
                        <button class="top-menu-btn" onclick="uploadOrderDocument('${order.orderId}')" style="padding: 2px 4px; margin: 0 1px; border: 1px solid #ccc; border-radius: 2px; background: #fff; cursor: pointer; font-size: 10px; min-width: 20px; height: 20px; line-height: 1;" title="ì£¼ë¬¸ì„œ ì—…ë¡œë“œ">ğŸ“¤</button>
                        <button class="top-menu-btn preview-btn" onclick="viewOrderDocument('${order.orderId}')" data-order-id="${order.orderId}" data-file-type="ì£¼ë¬¸ì„œ" style="padding: 2px 4px; margin: 0 1px; border: 1px solid #ccc; border-radius: 2px; background: #fff; cursor: pointer; font-size: 10px; min-width: 20px; height: 20px; line-height: 1;" title="ì£¼ë¬¸ì„œ ë³´ê¸°">ğŸ‘ï¸</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            updatePreviewButtonStyles();
        }
        
        // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        async function updatePreviewButtonStyles() {
            const previewButtons = document.querySelectorAll('.preview-btn');
            
            // ëª¨ë“  ë²„íŠ¼ì„ ë³‘ë ¬ë¡œ ì²˜ë¦¬ (Promise.all ì‚¬ìš©)
            const promises = Array.from(previewButtons).map(async (button) => {
                const orderId = button.getAttribute('data-order-id');
                const fileType = button.getAttribute('data-file-type');
                
                try {
                    // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                    const response = await fetch(`/api/listFiles/${currentMode}/${orderId}/${fileType}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.files && data.files.length > 0) {
                            // íŒŒì¼ì´ ìˆìœ¼ë©´ ì—°í•œ íŒŒë€ ë°°ê²½
                            button.style.background = '#87CEEB';
                            button.style.color = 'white';
                        } else {
                            // íŒŒì¼ì´ ì—†ìœ¼ë©´ í° ë°°ê²½
                            button.style.background = '#fff';
                            button.style.color = 'black';
                        }
                    } else {
                        // ì‘ë‹µì´ ì‹¤íŒ¨í•œ ê²½ìš° í° ë°°ê²½
                        button.style.background = '#fff';
                        button.style.color = 'black';
                    }
                } catch (error) {
                    // ì—ëŸ¬ ì‹œ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€
                    button.style.background = '#fff';
                    button.style.color = 'black';
                }
            });
            
            // ëª¨ë“  ìš”ì²­ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            await Promise.all(promises);
        }
        
        // ë°œì£¼ì„œ ì—…ë¡œë“œ í•¨ìˆ˜
        function uploadOrderSheet(orderId) {
            uploadFile(orderId, 'ë°œì£¼ì„œ');
        }
        // ë°œì£¼ì„œ ë³´ê¸° í•¨ìˆ˜
        function viewOrderSheet(orderId) {
            viewFile(orderId, 'ë°œì£¼ì„œ');
        }
        // ì´ë©”ì¼ ì—…ë¡œë“œ í•¨ìˆ˜
        function uploadEmail(orderId) {
            uploadFile(orderId, 'Email');
        }
        // ì´ë©”ì¼ ë³´ê¸° í•¨ìˆ˜
        function viewEmail(orderId) {
            viewFile(orderId, 'Email');
        }
        // ì£¼ë¬¸ì„œ ì—…ë¡œë“œ í•¨ìˆ˜
        function uploadOrderDocument(orderId) {
            uploadFile(orderId, 'ì£¼ë¬¸ì„œ');
        }
        // ì£¼ë¬¸ì„œ ë³´ê¸° í•¨ìˆ˜
        function viewOrderDocument(orderId) {
            viewFile(orderId, 'ì£¼ë¬¸ì„œ');
        }
        
        // íŒŒì¼ ì—…ë¡œë“œ ê³µí†µ í•¨ìˆ˜
        function uploadFile(orderId, fileType) {
            // íŒŒì¼ ì…ë ¥ ìš”ì†Œ ìƒì„±
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.doc,.docx,.jpg,.jpeg,.png,.txt'; // í—ˆìš©í•  íŒŒì¼ í˜•ì‹
            fileInput.style.display = 'none';
                // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            fileInput.addEventListener('change', async function(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }
                        try {
                    // FormData ìƒì„±
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('orderNo', orderId); // orderIdë¥¼ orderNoë¡œë„ ì „ì†¡ (ì„œë²„ í˜¸í™˜ì„±)
                    formData.append('fileType', fileType);
                    formData.append('mode', currentMode); // í˜„ì¬ ëª¨ë“œ ì¶”ê°€
                    formData.append('orderId', orderId); // orderId ì‚¬ìš©
                    formData.append('originalFileName', file.name); // ì›ë³¸ íŒŒì¼ëª… ì „ì†¡ (í•œêµ­ì–´ ë³´ì¡´)
                                // ì„œë²„ë¡œ ì—…ë¡œë“œ (ë‚˜ì¤‘ì— í´ë¼ìš°ë””ì•„ë¡œ ì—°ê²°)
                    const response = await fetch('/api/uploadFile', {
                        method: 'POST',
                        body: formData
                    });
                                if (response.ok) {
                        const result = await response.json();
                        alert(`${fileType} íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\níŒŒì¼ëª…: ${orderId}_${fileType}`);
                        
                        // ì—…ë¡œë“œ ì„±ê³µ í›„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                        updatePreviewButtonStyles();
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (error) {
                    console.error(`[UPLOAD] ì—…ë¡œë“œ ì‹¤íŒ¨:`, error);
                    alert(`${fileType} íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì—ëŸ¬: ${error.message}`);
                }
                        // íŒŒì¼ ì…ë ¥ ìš”ì†Œ ì œê±°
                document.body.removeChild(fileInput);
            });
                // íŒŒì¼ ì…ë ¥ ìš”ì†Œë¥¼ DOMì— ì¶”ê°€í•˜ê³  í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ì „ì—­ ë³€ìˆ˜
        let currentFiles = [];
        let currentFileIndex = 0;
        let currentOrderId = '';
        let currentFileType = '';

        // íŒŒì¼ ë³´ê¸°/ë¯¸ë¦¬ë³´ê¸° ê³µí†µ í•¨ìˆ˜
        function viewFile(orderId, fileType) {
                // ì„œë²„ì—ì„œ íŒŒì¼ ëª©ë¡ ì¡°íšŒ
            fetch(`/api/listFiles/${currentMode}/${orderId}/${fileType}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                })
                .then(data => {
                    if (data.files && data.files.length > 0) {
                        // íŒŒì¼ ëª©ë¡ ì €ì¥
                        currentFiles = data.files;
                        currentFileIndex = 0;
                        currentOrderId = orderId;
                        currentFileType = fileType;
                                        // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
                        showPreviewModal();
                    } else {
                        alert(`${fileType} íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.`);
                    }
                })
                .catch(error => {
                    console.error(`[VIEW] íŒŒì¼ ì¡°íšŒ ì‹¤íŒ¨:`, error);
                    alert(`${fileType} íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì—ëŸ¬: ${error.message}`);
                });
        }

        // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
        function showPreviewModal() {
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const counter = document.getElementById('fileCounter');
            const fileList = document.getElementById('fileList');
                // ì œëª© ì„¤ì •
            title.textContent = `${currentFileType} íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° (${currentOrderId})`;
                // íŒŒì¼ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
            counter.textContent = `${currentFileIndex + 1} / ${currentFiles.length}`;
                // ì‚¬ì´ë“œë°”ì— íŒŒì¼ ëª©ë¡ ìƒì„±
            fileList.innerHTML = '';
            currentFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${index === currentFileIndex ? 'active' : ''}`;
                fileItem.onclick = () => selectFile(index);
                        // íŒŒì¼ ì•„ì´ì½˜ ê²°ì •
                const fileExtension = file.filename.split('.').pop().toLowerCase();
                let icon = 'ğŸ“„';
                if (fileExtension === 'pdf') icon = 'ğŸ“„';
                else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) icon = 'ğŸ–¼ï¸';
                else if (['doc', 'docx'].includes(fileExtension)) icon = 'ğŸ“';
                else if (['xls', 'xlsx'].includes(fileExtension)) icon = 'ğŸ“Š';
                        fileItem.innerHTML = `
                    <span class="file-icon">${icon}</span>
                    <span class="file-name" title="${file.filename}">${file.filename}</span>
                    <button class="delete-file-btn" onclick="deleteFile(event, ${index})" title="íŒŒì¼ ì‚­ì œ">ğŸ—‘ï¸</button>
                `;
                        fileList.appendChild(fileItem);
            });
                // ì²« ë²ˆì§¸ íŒŒì¼ í‘œì‹œ
            showCurrentFile();
                // ëª¨ë‹¬ í‘œì‹œ
            modal.style.display = 'flex';
        }

        // ì‚¬ì´ë“œë°”ì—ì„œ íŒŒì¼ ì„ íƒ
        function selectFile(index) {
            if (index >= 0 && index < currentFiles.length) {
                currentFileIndex = index;
                showCurrentFile();
                updateFileList();
                updateNavigationButtons();
            }
        }

        // íŒŒì¼ ëª©ë¡ ì—…ë°ì´íŠ¸ (í™œì„± íŒŒì¼ í‘œì‹œ)
        function updateFileList() {
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach((item, index) => {
                if (index === currentFileIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // í˜„ì¬ íŒŒì¼ í‘œì‹œ
        function showCurrentFile() {
            if (currentFiles.length === 0) return;
                const currentFile = currentFiles[currentFileIndex];
            const previewFrame = document.getElementById('previewFrame');
            const counter = document.getElementById('fileCounter');
                // íŒŒì¼ í™•ì¥ì í™•ì¸
            const fileExtension = currentFile.filename.split('.').pop().toLowerCase();
                // ë¯¸ë¦¬ë³´ê¸° ì „ìš© API ì‚¬ìš© (ë‹¤ìš´ë¡œë“œ ë°©ì§€)
            const previewUrl = `/api/previewFile/${currentMode}/${currentOrderId}/${currentFileType}/${encodeURIComponent(currentFile.filename)}`;
                // PDF, ì´ë¯¸ì§€ íŒŒì¼ì˜ ê²½ìš° ì§ì ‘ ë¯¸ë¦¬ë³´ê¸°
            if (['pdf', 'jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                previewFrame.src = previewUrl;
            }
            // ê¸°íƒ€ íŒŒì¼ì˜ ê²½ìš° ë‹¤ìš´ë¡œë“œ ë§í¬ í‘œì‹œ
            else {
                const downloadUrl = `/api/downloadFile/${currentMode}/${currentOrderId}/${currentFileType}/${encodeURIComponent(currentFile.filename)}`;
                previewFrame.src = `data:text/html,<html><body style="text-align:center;padding:50px;font-family:Arial;">
                    <h3>ë¯¸ë¦¬ë³´ê¸° ë¶ˆê°€ëŠ¥í•œ íŒŒì¼ í˜•ì‹</h3>
                    <p>íŒŒì¼ëª…: ${currentFile.filename}</p>
                    <p>í¬ê¸°: ${(currentFile.size / 1024).toFixed(1)} KB</p>
                    <a href="${downloadUrl}" style="background:#007bff;color:white;padding:10px 20px;text-decoration:none;border-radius:5px;">ğŸ“¥ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</a>
                </body></html>`;
            }
                // ì¹´ìš´í„° ì—…ë°ì´íŠ¸
            counter.textContent = `${currentFileIndex + 1} / ${currentFiles.length}`;
                // ì‚¬ì´ë“œë°” íŒŒì¼ ëª©ë¡ ì—…ë°ì´íŠ¸
            updateFileList();
                // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateNavigationButtons();
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevFileBtn');
            const nextBtn = document.getElementById('nextFileBtn');
                prevBtn.disabled = currentFileIndex === 0;
            nextBtn.disabled = currentFileIndex === currentFiles.length - 1;
        }
        

        // í™•ì¥/ì¶•ì†Œ ê¸°ëŠ¥
        document.getElementById("expandButton").addEventListener("click", () => {
            const detailArea = document.getElementById("detailButtonArea");
            const expandBtn = document.getElementById("expandButton");
                if (detailArea.style.display === "none") {
                detailArea.style.display = "flex";
                expandBtn.classList.add("expanded");
                expandBtn.textContent = "â–²";
            } else {
                detailArea.style.display = "none";
                expandBtn.classList.remove("expanded");
                expandBtn.textContent = "â–¼";
            }
        });
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° í‘œì‹œ
        document.addEventListener('DOMContentLoaded', () => {
                // URL íŒŒë¼ë¯¸í„°ì— ë”°ë¼ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
            if (urlMode) {
                // ëª¨ë“  ë²„íŠ¼ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
                ntBtn.classList.remove("selected");
                smBtn.classList.remove("selected");
                        // í•´ë‹¹ ëª¨ë“œ ë²„íŠ¼ì— selected í´ë˜ìŠ¤ ì¶”ê°€
                if (urlMode === "NT") {
                    ntBtn.classList.add("selected");
                    currentMode = 'NT';
                } else if (urlMode === "SM") {
                    smBtn.classList.add("selected");
                    currentMode = 'SM';
                }
            } else {
                // URL íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ NTë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
                ntBtn.classList.add("selected");
                smBtn.classList.remove("selected");
                currentMode = 'NT';
            }
                // ë…„ë„ í‘œì‹œ ì—…ë°ì´íŠ¸
            yearDisplay.textContent = currentYear;
                loadOrderData();
        });

        // íŒŒì¼ ì‚­ì œ í•¨ìˆ˜
        async function deleteFile(event, fileIndex) {
            event.stopPropagation(); // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ë°©ì§€
            
            if (currentFiles.length === 0 || fileIndex >= currentFiles.length) {
                return;
            }
            
            const fileToDelete = currentFiles[fileIndex];
            const confirmDelete = confirm(`íŒŒì¼ "${fileToDelete.filename}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            
            if (!confirmDelete) {
                return;
            }
            
            try {
                // ì„œë²„ì— íŒŒì¼ ì‚­ì œ ìš”ì²­
                const response = await fetch(`/api/deleteFile/${currentMode}/${currentOrderId}/${currentFileType}/${encodeURIComponent(fileToDelete.filename)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // ì‚­ì œ ì„±ê³µ í›„ í™”ë©´ ë¦¬í”„ë ˆì‹œ
                    location.reload();
                } else {
                    const errorData = await response.json();
                    alert(`íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                alert(`íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('closePreviewBtn').addEventListener('click', () => {
            document.getElementById('previewModal').style.display = 'none';
        });


        document.getElementById('prevFileBtn').addEventListener('click', () => {
            if (currentFileIndex > 0) {
                currentFileIndex--;
                showCurrentFile();
            }
        });

        document.getElementById('nextFileBtn').addEventListener('click', () => {
            if (currentFileIndex < currentFiles.length - 1) {
                currentFileIndex++;
                showCurrentFile();
            }
        });

        document.getElementById('downloadCurrentBtn').addEventListener('click', () => {
            if (currentFiles.length > 0) {
                const currentFile = currentFiles[currentFileIndex];
                const fileUrl = `/api/downloadFile/${currentMode}/${currentOrderId}/${currentFileType}/${encodeURIComponent(currentFile.filename)}`;
                        // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                const link = document.createElement('a');
                link.href = fileUrl;
                link.download = currentFile.filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('previewModal').addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') {
                document.getElementById('previewModal').style.display = 'none';
            }
        });

</script>
</body>
</html>
