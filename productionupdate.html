<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Production Update</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #000;
      line-height: 1.5;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: -1;
    }
    .page {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      margin: 0;
      padding-bottom: 10px;
    }
    .top-menu {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .left-menu {
      display: flex;
      gap: 3px;
    }
    .right-menu {
      display: flex;
      gap: 3px;
    }
    .top-menu-btn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
    }
    .top-menu-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .top-menu-btn.doc-btn.selected {
      background: black;
      color: white;
      border-color: black;
    }
    .top-menu-btn.doc-btn {
      background: #fff;
      color: #000;
      border-color: #ccc;
    }
    .top-menu-btn.doc-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .flex-container {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      gap: 20px;
      margin-top: 20px;
    }
    .box {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    textarea {
      width: 100%;
      height: 300px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 1rem;
      padding: 15px;
      margin-bottom: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      resize: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
      white-space: pre;
      word-wrap: break-word;
    }
    textarea:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 2px 12px rgba(0,123,255,0.2);
    }
    /* ëª¨ë“  ë²„íŠ¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ - Exportì™€ ë™ì¼ */
    button {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
      transition: all 0.2s ease;
    }

    button:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    .button-area {
      text-align: center;
      margin-top: 10px;
    }

    #outputArea[readonly] {
      background-color: #f9f9f9;
      color: #444;
    }
    /* Order Header ìŠ¤íƒ€ì¼ */
    .order-header {
      display: flex;
      justify-content: space-between;
      padding-top: 10px;
      margin-top: 10px;
      font-weight: bold;
      font-size: 1.1rem;
    }
    /* ì™¼ìª½/ì¤‘ì•™/ì˜¤ë¥¸ìª½ ì˜ì—­ì— input ì‚¬ìš© */
    .order-header .left, .order-header .center, .order-header .right {
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1;
      justify-content: center;
    }
    .order-header .left input,
    .order-header .center input,
    .order-header .right input {
      font-size: 1rem;
      width: 120px;
      padding: 4px 4px;
      height: 24px;
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Production Update</h1>

  <div class="top-menu">
    <!-- ì™¼ìª½: Production -->
    <div class="left-menu">
      <button type="button" onclick="location.href='production.html'" class="top-menu-btn">Production</button>
    </div>
    <!-- ì˜¤ë¥¸ìª½: O/C, OIP, A, C -->
    <div class="right-menu">
      <button id="ocBtn" class="top-menu-btn doc-btn selected">O/C</button>
      <button id="oipBtn" class="top-menu-btn doc-btn">OIP</button>
      <button id="cBtn" class="top-menu-btn doc-btn">ë¶„ì„í‘œ</button>
    </div>
  </div>

  <!-- Order No, TF NO, Date ì…ë ¥ ì˜ì—­ -->
  <div class="order-header">
    <div class="left">
      <span>ORDER NO :</span>
      <input type="text" id="orderNoInput" autocomplete="off" />
    </div>
    <div class="center">
      <span>TF NO :</span>
      <input type="text" id="tfNoInput" autocomplete="off" />
    </div>
    <div class="right">
      <span>DATE :</span>
      <input type="text" id="orderDateInput" autocomplete="off" />
    </div>
  </div>

  <div class="flex-container">
    <div class="box">
      <textarea id="inputArea" placeholder="O/C ëª¨ë“œ:
ORDER NO/ TF NO/ DATE ì…ë ¥ í›„

ì „ì²´ì„ íƒ: Ctrl+A
ë³µì‚¬: Ctrl+C
ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°: Ctrl+V"></textarea>
    </div>
    <div class="box">
      <textarea id="outputArea" readonly placeholder=""></textarea>
    </div>
  </div>

  <div class="button-area">
    <button id="organizeBtn">Organize</button>
    <button id="convertBtn">Convert</button>
    <button id="exportBtn">Export</button>
  </div>
</div>

<script>
  // ========================================
  // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
  // ========================================
  let globalParsedData = []; // Convertëœ ë°ì´í„° ì €ì¥
  let selectedDoc = "O/C";   // í˜„ì¬ ì„ íƒëœ ëª¨ë“œ (O/C, OIP, C)

  // ========================================
  // Order No, TF NO, Date í•„ë“œ ê°€ì ¸ì˜¤ê¸° ê³µí†µ í•¨ìˆ˜
  // ========================================
  function getOrderFields() {
    return {
      orderNoInput: document.getElementById("orderNoInput"),
      tfNoInput: document.getElementById("tfNoInput"),
      orderDateInput: document.getElementById("orderDateInput")
    };
  }

  // Order No, TF NO, Date ì´ˆê¸°í™” í•¨ìˆ˜
  function initializeOrderFields() {
    const { orderNoInput, tfNoInput, orderDateInput } = getOrderFields();
    
    if (orderNoInput) {
      orderNoInput.value = '';
    }
    
    if (tfNoInput) {
      tfNoInput.value = '';
    }
    
    if (orderDateInput) {
      orderDateInput.value = '';
    }
  }

  // ========================================
  // ëª¨ë“œì— ë”°ë¥¸ placeholder ì„¤ì • í•¨ìˆ˜
  // - ì„ íƒëœ ëª¨ë“œ(O/C, OIP, C)ì— ë”°ë¼ inputAreaì˜ placeholder í…ìŠ¤íŠ¸ ë³€ê²½
  // ========================================
  function updatePlaceholder() {
    const inputArea = document.getElementById("inputArea");
    if (!inputArea) return;
    
    switch (selectedDoc) {
      case "O/C":
        // O/C ëª¨ë“œ: ORDER NO, TF NO, DATE ì…ë ¥ í•„ìš”
        inputArea.placeholder = `O/C ëª¨ë“œ:
ORDER NO/ TF NO/ DATE ì…ë ¥ í›„

ì „ì²´ì„ íƒ: Ctrl+A
ë³µì‚¬: Ctrl+C
ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°: Ctrl+V`;
        break;
        
      case "OIP":
        // OIP ëª¨ë“œ: ORDER NO, TF NO, DATE ì…ë ¥ ë¶ˆí•„ìš” (ë°ì´í„°ì—ì„œ ìë™ ì¶”ì¶œ)
        inputArea.placeholder = `OIP ëª¨ë“œ:
ORDER NO/ TF NO/ DATE ë¶ˆí•„ìš”

ì „ì²´ì„ íƒ: Ctrl+A
ë³µì‚¬: Ctrl+C
ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°: Ctrl+V`;
        break;
        
        
      case "C":
        // ë¶„ì„í‘œ ëª¨ë“œ: íŠ¹ì • í˜•ì‹ì˜ ë¶„ì„í‘œ ë°ì´í„° ì…ë ¥
        inputArea.placeholder = `ë¶„ì„í‘œ ëª¨ë“œ:
Order No.: 71428736.30
Tot. weight (kg): 1.838,532
Width: 620,0
Type: PHD 7.0
Customer Order No.: SM-2025-01`;
        break;
        
      default:
        inputArea.placeholder = "Production data input area\nEnter your production information here...";
    }
  }

  // ========================================
  // ëª¨ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  // - O/C, OIP, C ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë“œ ë³€ê²½ ë° UI ì—…ë°ì´íŠ¸
  // ========================================
  function setupDocButtons() {
    const ocBtn = document.getElementById("ocBtn");
    const oipBtn = document.getElementById("oipBtn");
    const cBtn = document.getElementById("cBtn");

    // O/C ëª¨ë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    if (ocBtn) {
      ocBtn.addEventListener("click", () => {
        selectedDoc = "O/C"; // O/C ëª¨ë“œë¡œ ë³€ê²½
        ocBtn.classList.add("selected");
        oipBtn.classList.remove("selected");
        cBtn.classList.remove("selected");
        updatePlaceholder(); // placeholder ì—…ë°ì´íŠ¸
        saveInputData(); // DOC ë³€ê²½ ì‹œ ì €ì¥
      });
    }

    // OIP ëª¨ë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    if (oipBtn) {
      oipBtn.addEventListener("click", () => {
        selectedDoc = "OIP"; // OIP ëª¨ë“œë¡œ ë³€ê²½
        oipBtn.classList.add("selected");
        ocBtn.classList.remove("selected");
        cBtn.classList.remove("selected");
        updatePlaceholder(); // placeholder ì—…ë°ì´íŠ¸
        saveInputData(); // DOC ë³€ê²½ ì‹œ ì €ì¥
      });
    }

    // ë¶„ì„í‘œ(C) ëª¨ë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    if (cBtn) {
      cBtn.addEventListener("click", () => {
        selectedDoc = "C"; // ë¶„ì„í‘œ ëª¨ë“œë¡œ ë³€ê²½
        cBtn.classList.add("selected");
        ocBtn.classList.remove("selected");
        oipBtn.classList.remove("selected");
        updatePlaceholder(); // placeholder ì—…ë°ì´íŠ¸
        saveInputData(); // DOC ë³€ê²½ ì‹œ ì €ì¥
      });
    }
  }

  // Convert ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  function setupConvertButton() {
    const convertBtn = document.getElementById("convertBtn");
    if (!convertBtn) {
      return;
    }
    
    convertBtn.removeEventListener("click", handleConvertClick);
    convertBtn.addEventListener("click", handleConvertClick);
  }

  // ========================================
  // Convert ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
  // ========================================
  function handleConvertClick() {
    const inputText = document.getElementById("inputArea").value;
    
    if (!inputText.trim()) {
      alert("ì…ë ¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    try {
      // DOC ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥¸ ë³€í™˜ ë¡œì§ ì ìš©
      if (selectedDoc === "O/C") {
        convertOCMode(inputText);
      } else if (selectedDoc === "OIP") {
        convertOIPMode(inputText);
      } else if (selectedDoc === "C") {
        convertCMode(inputText);
      }
    } catch (error) {
      alert("ë°ì´í„° ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }
  
  // ========================================
  // 1. O/C ëª¨ë“œ Convert
  // ========================================
  function convertOCMode(inputText) {
    // ì…ë ¥ í…ìŠ¤íŠ¸ì—ì„œ í•„ìš”í•œ ì •ë³´ ì¶”ì¶œ
    const extractedData = extractProductionData(inputText);
    
    // ì¶”ì¶œëœ ë°ì´í„°ë¥¼ í¬ë§·íŒ…í•˜ì—¬ ì¶œë ¥
    const formattedOutput = formatProductionOutput(extractedData);
    
    document.getElementById("outputArea").value = formattedOutput;
    globalParsedData = [extractedData];
  }
  
  // ì…ë ¥ í…ìŠ¤íŠ¸ì—ì„œ production ë°ì´í„° ì¶”ì¶œ (ìƒˆë¡œìš´ êµ¬ì¡°)
  function extractProductionData(inputText) {
    const lines = inputText.split('\n').map(line => line.trim()).filter(line => line);
    
    // PHDê°€ ìˆëŠ” ìˆœì„œëŒ€ë¡œ ì•„ì´í…œ ë²ˆí˜¸ ìë™ ìƒì„±
    const phdIndices = [];
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      if (line.toUpperCase().includes('PHD')) {
        phdIndices.push(i);
      }
    }
    
    if (phdIndices.length === 0) {
      throw new Error('PHD ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    // ê° PHDë³„ë¡œ ë°ì´í„° ì¶”ì¶œ (ìˆœì„œëŒ€ë¡œ 0001, 0002... ë²ˆí˜¸ ë¶€ì—¬)
    const items = [];
    for (let i = 0; i < phdIndices.length; i++) {
      const phdIndex = phdIndices[i];
      const itemNo = String(i + 1).padStart(4, '0'); // 0001, 0002, 0003...
      const itemData = extractItemDataByIndex(lines, phdIndex, itemNo);
      items.push(itemData);
    }
    
    return items;
  }

  // PHD ì¸ë±ìŠ¤ë¡œ ë°ì´í„° ì¶”ì¶œ (ìƒˆë¡œìš´ êµ¬ì¡°)
  function extractItemDataByIndex(lines, phdIndex, itemNo) {
    const data = {
      no: itemNo,
      phd: '',
      width: '',
      length: '',
      tfkg: '',
      w: ''
    };
    
    // ë‹¤ìŒ PHD ìœ„ì¹˜ ì°¾ê¸°
    let nextPhdIndex = lines.length;
    for (let i = phdIndex + 1; i < lines.length; i++) {
      if (lines[i].trim().toUpperCase().includes('PHD')) {
        nextPhdIndex = i;
        break;
      }
    }
    
    const searchEnd = nextPhdIndex;
    
    // í•´ë‹¹ ë²”ìœ„ì—ì„œ ë°ì´í„° ì¶”ì¶œ
    for (let i = phdIndex; i < searchEnd; i++) {
      const line = lines[i].trim();
      
      // PHD ì¶”ì¶œ (PHD 6.0)
      const phdMatch = line.match(/PHD\s+([\d.]+)/i);
      if (phdMatch && !data.phd) {
        data.phd = phdMatch[1];
        continue;
      }
      
      // Width ì¶”ì¶œ (ë‹¨ë… ìˆ«ì ë¼ì¸)
      if (/^\d+$/.test(line) && !data.width && i > phdIndex) {
        data.width = line;
        continue;
      }
      
      
      // Length ì¶”ì¶œ (Length ë‹¤ìŒ ì¤„ì˜ 40.500 m â†’ 40500)
      if (line === 'Length' && i + 1 < searchEnd && !data.length) {
        const nextLine = lines[i + 1].trim();
        const lengthMatch = nextLine.match(/^(\d+(?:\.\d+)?)\s*m$/i);
        if (lengthMatch) {
          const lengthStr = lengthMatch[1];
          const length = parseFloat(lengthStr) * 1000; // më¥¼ mmë¡œ ë³€í™˜
          data.length = Math.round(length).toString();
        }
        continue;
      }
      
      
      // O/Ckg ì¶”ì¶œ (Reels ë‹¤ìŒ ì¤„ì˜ ì²« ë²ˆì§¸ ìˆ«ì)
      if (line.toUpperCase() === 'REELS' && i + 1 < searchEnd && !data.tfkg) {
        const nextLine = lines[i + 1].trim();
        const tfkgMatch = nextLine.match(/^([^\s]+)/);
        if (tfkgMatch) {
          // ì ì€ ì œê±°í•˜ê³  ì‰¼í‘œëŠ” ì ìœ¼ë¡œ ë³€ê²½
          const cleanedValue = tfkgMatch[1].replace(/\./g, '').replace(/,/g, '.');
          data.tfkg = cleanedValue;
        }
        continue;
      }
      
      // w ì¶”ì¶œ (27. WK 2025 â†’ 27w)
      const wMatch = line.match(/(\d+)\.\s*WK\s*\d{4}/i);
      if (wMatch && !data.w) {
        data.w = wMatch[1] + 'w';
        continue;
      }
    }
    
    return data;
  }

  // ì¶”ì¶œëœ ë°ì´í„°ë¥¼ í¬ë§·íŒ…í•˜ì—¬ ì¶œë ¥
  function formatProductionOutput(items) {
    let output = "";
    
    items.forEach((item, index) => {
      output += `itemno - ${item.no}\n`;
      output += `PHD - ${item.phd || ''}\n`;
      output += `width - ${item.width || ''}\n`;
      output += `length - ${item.length || ''}\n`;
      output += `tfkg - ${item.tfkg || ''}\n`;
      output += `w - ${item.w || ''}\n`;
      
      if (index < items.length - 1) {
        output += '\n';
      }
    });
    
    return output;
  }
  
  // ========================================
  // 2. OIP ëª¨ë“œ Convert
  // ========================================
  function convertOIPMode(inputText) {
    // ì…ë ¥ í…ìŠ¤íŠ¸ì—ì„œ íƒ­ìœ¼ë¡œ êµ¬ë¶„ëœ ë°ì´í„° ì¶”ì¶œ
    const extractedData = extractOIPData(inputText);
    
    // ì¶”ì¶œëœ ë°ì´í„°ë¥¼ í¬ë§·íŒ…í•˜ì—¬ ì¶œë ¥
    const formattedOutput = formatOIPOutput(extractedData);
    
    document.getElementById("outputArea").value = formattedOutput;
    
    // ğŸ”§ OIP ëª¨ë“œ: ë°ì´í„° ëˆ„ì  ë°©ì‹ìœ¼ë¡œ ë³€ê²½ (ìˆœì°¨ì  ì—…ë¡œë“œ ì§€ì›)
    if (!globalParsedData || globalParsedData.length === 0) {
      globalParsedData = [extractedData];
    } else {
      // ê¸°ì¡´ ë°ì´í„°ì— ìƒˆ ë°ì´í„° ì¶”ê°€
      globalParsedData.push(extractedData);
    }
    
  }
  
  // ========================================
  // OIP ëª¨ë“œ: ëˆ„ì ëœ ë°ì´í„° ì´ˆê¸°í™” í•¨ìˆ˜
  // ========================================
  function clearOIPData() {
    globalParsedData = [];
    document.getElementById("outputArea").value = "";
  }
  
  // producedkg ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬ê¹Œì§€ í¬ë§·íŒ… í•¨ìˆ˜
  function formatProducedkg(value) {
    if (!value || value === '') return '';
    
    // ìˆ«ìë¡œ ë³€í™˜
    const numValue = parseFloat(value);
    if (isNaN(numValue)) return value;
    
    // ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬ê¹Œì§€ í‘œì‹œ (000. â†’ 000.0, 112. â†’ 112.0)
    return numValue.toFixed(1);
  }

  // OIP ë°ì´í„° ì¶”ì¶œ í•¨ìˆ˜
  function extractOIPData(inputText) {
    const lines = inputText.split('\n').map(line => line.trim()).filter(line => line);
    const items = [];
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      
      // íƒ­ìœ¼ë¡œ êµ¬ë¶„ëœ ë°ì´í„°ì¸ì§€ í™•ì¸
      if (line.includes('\t')) {
        const columns = line.split('\t');
        
        if (columns.length >= 10) { // ìµœì†Œ 10ê°œ ì—´ì´ ìˆì–´ì•¼ í•¨ (organize í›„)
          const item = {
            orderno: columns[0] || '', // 1ì—´: ì£¼ë¬¸ë²ˆí˜¸ (EK-2025-01)
            tfno: columns[3] || '', // 4ì—´: TFë²ˆí˜¸ (71430617)
            no: '', // ì•„ì´í…œë²ˆí˜¸ (5ì—´ì—ì„œ ì¶”ì¶œ)
            phd: '', // PHD (3ì—´ì—ì„œ ì¶”ì¶œ)
            width: columns[1] || '', // 2ì—´: í­ (620)
            length: '', // length (6ì—´ì—ì„œ ì¶”ì¶œ)
            tfkg: (columns[6] || '').replace(/,/g, ''), // 7ì—´: tfkg (265) - ì½¤ë§ˆ ì œê±°
            w: '', // W (10ì—´ì—ì„œ ì¶”ì¶œ)
            producedkg: formatProducedkg((columns[7] || '').replace(/,/g, '')), // 8ì—´: producedkg (266.5) - ì½¤ë§ˆ ì œê±° í›„ ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬ê¹Œì§€
            deliveredkg: (columns[8] || '').replace(/,/g, '') // 9ì—´: deliveredkg (0.0) - ì½¤ë§ˆ ì œê±°
          };
          
          // ì•„ì´í…œë²ˆí˜¸ ì²˜ë¦¬ (5ì—´: "10" â†’ "0001")
          if (columns[4]) {
            const itemNo = columns[4].replace(/0$/, ''); // ë§ˆì§€ë§‰ 0ë§Œ ì œê±°
            item.no = itemNo.padStart(4, '0'); // 4ìë¦¬ë¡œ íŒ¨ë”©
          }
          
          // PHD ì²˜ë¦¬ (3ì—´: "PHD 6.0" â†’ "6.0")
          if (columns[2]) {
            const phdMatch = columns[2].match(/PHD\s+([\d.]+)/i);
            if (phdMatch) {
              item.phd = phdMatch[1];
            }
          }
          
          // length ì²˜ë¦¬ (6ì—´: "40,500" â†’ "40500")
          if (columns[5]) {
            item.length = columns[5].replace(/,/g, '');
          }
          
          // W ì²˜ë¦¬ (10ì—´: "12.2025" â†’ "12w")
          if (columns[9]) {
            const wMatch = columns[9].match(/^(\d+)\.\d+$/);
            if (wMatch) {
              item.w = wMatch[1] + 'w';
            }
          }
          
          items.push(item);
        }
      }
    }
    
    return items;
  }
  
  // OIP ì¶œë ¥ í¬ë§·íŒ… í•¨ìˆ˜
  function formatOIPOutput(items) {
    let output = "";
    
    items.forEach((item, index) => {
      output += `orderno - ${item.orderno || ''}\n`;
      output += `tfno - ${item.tfno || ''}\n`;
      output += `itemno - ${item.no}\n`;
      output += `PHD - ${item.phd || ''}\n`;
      output += `width - ${item.width || ''}\n`;
      output += `length - ${item.length || ''}\n`;
      output += `tfkg - ${item.tfkg || ''}\n`;
      output += `W - ${item.w || ''}\n`;
      output += `producedkg - ${item.producedkg || ''}\n`;
      output += `deliveredkg - ${item.deliveredkg || ''}\n`;
      
      if (index < items.length - 1) {
        output += '\n';
      }
    });
    
    return output;
  }
  

  // ========================================
  // 3. ë¶„ì„í‘œ ëª¨ë“œ Convert
  // ========================================
  function convertCMode(inputText) {
    
    // ì…ë ¥ í…ìŠ¤íŠ¸ì—ì„œ í•„ìš”í•œ ì •ë³´ ì¶”ì¶œ
    const extractedData = extractCModeData(inputText);
    
    if (!extractedData) {
      alert("ë¶„ì„í‘œ ëª¨ë“œ ë°ì´í„°ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
    // ì¶”ì¶œëœ ë°ì´í„°ë¥¼ í¬ë§·íŒ…í•˜ì—¬ ì¶œë ¥
    const formattedOutput = formatCModeOutput(extractedData);
    document.getElementById("outputArea").value = formattedOutput;
    
    // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (Export ì‹œ ì‚¬ìš©)
    globalParsedData = [extractedData];
    
  }
  
  // ë¶„ì„í‘œ ëª¨ë“œ ë°ì´í„° ì¶”ì¶œ í•¨ìˆ˜
  function extractCModeData(inputText) {
    try {
      const lines = inputText.split('\n').map(line => line.trim()).filter(line => line);
      
      let tfno = '';
      let itemno = '';
      let orderno = '';
      let phd = '';
      let width = '';
      let tfkg = '';
      
      for (const line of lines) {
        // Customer Order No.: EK-2024-04 (ë” êµ¬ì²´ì ì¸ ì¡°ê±´ì„ ë¨¼ì € í™•ì¸)
        if (line.includes('Customer Order No.:')) {
          // ë” ê°„ë‹¨í•œ ë°©ë²•: "Customer Order No.: " ì´í›„ì˜ ëª¨ë“  í…ìŠ¤íŠ¸ ì¶”ì¶œ
          const colonIndex = line.indexOf('Customer Order No.:');
          if (colonIndex !== -1) {
            orderno = line.substring(colonIndex + 'Customer Order No.:'.length).trim();
          }
        }
        // Order No.: 71424414.20
        else if (line.includes('Order No.:')) {
          const match = line.match(/Order No\.:\s*(\d+)\.(\d+)/);
          if (match) {
            tfno = match[1]; // 71424414
            const itemPart = match[2]; // 20
            
            // 20ì—ì„œ 0ì„ 1ê°œë§Œ ë¹¼ê³  4ìë¦¬ë¡œ ë§Œë“¤ê¸° (A ëª¨ë“œì™€ ë™ì¼)
            let itemNoStr = itemPart;
            if (itemNoStr.endsWith('0') && itemNoStr.length > 1) {
              itemNoStr = itemNoStr.slice(0, -1);
            }
            itemno = itemNoStr.padStart(4, '0'); // 0002
          }
        }
        // Tot. weight (kg): 549.845
        else if (line.includes('Tot. weight (kg):')) {
          const match = line.match(/Tot\. weight \(kg\):\s*([\d.,]+)/);
          if (match) {
            // ì (.)ê³¼ ì½¤ë§ˆ(,)ë¥¼ ëª¨ë‘ ì œê±°í•œ í›„ ë’¤ì—ì„œ 3ìë¦¬ ì•ì— ì (.) ì¶”ê°€
            let rawValue = match[1];
            
            // ì (.)ê³¼ ì½¤ë§ˆ(,) ëª¨ë‘ ì œê±°
            rawValue = rawValue.replace(/[.,]/g, '');
            
            // ë’¤ì—ì„œ 3ìë¦¬ ì•ì— ì (.) ì¶”ê°€
            if (rawValue.length > 3) {
              rawValue = rawValue.slice(0, -3) + '.' + rawValue.slice(-3);
            }
            
            // ìˆ«ì ìœ íš¨ì„± ê²€ì‚¬ë§Œ í•˜ê³  ì›ë³¸ ë¬¸ìì—´ ìœ ì§€ (ë§¨ ë§ˆì§€ë§‰ 0 ë³´ì¡´)
            const numericValue = parseFloat(rawValue);
            tfkg = isNaN(numericValue) ? '' : rawValue;
          }
        }
        // Width: 770.0
        else if (line.includes('Width:')) {
          const match = line.match(/Width:\s*([\d.,]+)/);
          if (match) {
            width = match[1].replace(/,0$/, '').replace(/,/g, '');
          }
        }
        // Type: PHD 5.0
        else if (line.includes('Type: PHD')) {
          const match = line.match(/Type: PHD\s*([\d.]+)/);
          if (match) {
            phd = match[1];
          }
        }
      }
      
      // í•„ìˆ˜ ë°ì´í„° ê²€ì¦
      if (!tfno || !itemno || !orderno) {
        return null;
      }
      
      return {
        tfno: tfno,
        itemno: itemno,
        orderno: orderno,
        phd: phd,
        width: width,
        tfkg: tfkg,
        producedkg: tfkg // Tot. weight (kg) ê°’ì„ producedkgë¡œ ì‚¬ìš© (ë¶„ì„í‘œ ëª¨ë“œ)
      };
      
    } catch (error) {
      return null;
    }
  }
  
  // ë¶„ì„í‘œ ëª¨ë“œ ì¶œë ¥ í¬ë§·íŒ… í•¨ìˆ˜
  function formatCModeOutput(data) {
    return `tfno - ${data.tfno}
itemno - ${data.itemno}
orderno - ${data.orderno}
PHD: ${data.phd}
Width: ${data.width}
producedkg: ${data.tfkg}`;
  }




  // Export ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  function setupExportButton() {
    const exportBtn = document.getElementById("exportBtn");
    if (!exportBtn) {
      return;
    }
    
    exportBtn.removeEventListener("click", handleExportClick);
    exportBtn.addEventListener("click", handleExportClick);
  }
  

  // ========================================
  // Export ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (O/C, OIP, ë¶„ì„í‘œ ëª¨ë“œ ê³µí†µ)
  // ========================================
  function handleExportClick() {
    if (!globalParsedData || globalParsedData.length === 0) {
      alert("ë¨¼ì € Convertë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.");
      return;
    }
    
    // Order No, TF NO, Date í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
    const { orderNoInput, tfNoInput, orderDateInput } = getOrderFields();
    const orderNo = orderNoInput ? orderNoInput.value.trim() : '';
    const tfNo = tfNoInput ? tfNoInput.value.trim() : '';
    const orderDate = orderDateInput ? orderDateInput.value.trim() : '';
    
    // DOC ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥¸ ì €ì¥ ë¡œì§ ì ìš©
    if (selectedDoc === "OIP") {
      // ========================================
      // OIP ëª¨ë“œ Export: ì£¼ë¬¸ë³„ ê·¸ë£¹í™” ì²˜ë¦¬ (ì£¼ë¬¸ ë³µì‚¬ ë°©ì§€)
      // ========================================
      saveOIPDataToOrderData();
    } else if (selectedDoc === "O/C") {
      // ========================================
      // O/C ëª¨ë“œ Export: Order No í•„ìˆ˜, ê¸°ì¡´ ì£¼ë¬¸ ì—…ë°ì´íŠ¸
      // ========================================
      if (!orderNo) {
        alert("Order Noë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      saveOCDataToOrderData(orderNo, tfNo, orderDate, globalParsedData);
    } else if (selectedDoc === "C") {
      // ========================================
      // ë¶„ì„í‘œ ëª¨ë“œ Export: ë‹¨ì¼ ë¶„ì„í‘œ ë°ì´í„° ì²˜ë¦¬
      // ========================================
      if (!globalParsedData || globalParsedData.length === 0) {
        alert("ë¶„ì„í‘œ ëª¨ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Convertë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.");
        return;
      }
      saveCModeDataToOrderData(globalParsedData);
    }
  }

  // ========================================
  // O/C ëª¨ë“œ Export: order.html ë°©ì‹ìœ¼ë¡œ ì €ì¥ ë¡œì§ ìˆ˜ì •
  // ========================================
  async function saveOCDataToOrderData(orderNo, tfNo, tfDate, parsedData) {
    try {
      
      // 1. parsedData ì²˜ë¦¬
      let actualParsedData;
      if (Array.isArray(parsedData) && parsedData.length > 0 && Array.isArray(parsedData[0])) {
        actualParsedData = parsedData[0];
      } else if (Array.isArray(parsedData)) {
        actualParsedData = parsedData;
      } else {
        actualParsedData = [parsedData];
      }
      
      // 2. ë°ì´í„° ê²€ì¦ ë° ì •ë¦¬
      
      const validItems = actualParsedData.filter(data => {
        const phd = parseFloat(data.phd);
        return !isNaN(phd) && data.width && data.length;
      }).map(data => {
        const processedItem = {
          phd: parseFloat(data.phd).toString(), // "4.0" -> "4"
          width: data.width,
          length: data.length,
          itemNo: data.no || '',
          w: data.w || '',
          tfkg: data.tfkg || ''
        };
        return processedItem;
      });

      const invalidItemsCount = actualParsedData.length - validItems.length;
      
      if (validItems.length === 0) {
        alert("ìœ íš¨í•œ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤. PHD, Width, Lengthê°€ ëª¨ë‘ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }

      // 3. ì„œë²„ì— ì§ì ‘ ì—…ë°ì´íŠ¸ ìš”ì²­ (ì„œë²„ì—ì„œ ì£¼ë¬¸/ì•„ì´í…œ ì°¾ê¸° ë° ë§¤ì¹­ ì²˜ë¦¬)
      const saveResponse = await fetch('/api/updateOrder', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          searchOrderBy: 'orderNo',
          orderNo: orderNo,
          searchMethod: 'phdWidthLength',
          updateFields: ['tfNo', 'tfDate'],
          tfNo: tfNo,
          tfDate: tfDate,
          itemUpdateFields: ['itemNo', 'w', 'tfkg'],
          items: validItems
        })
      });
      
      let serverProcessedItems = 0;
      let skippedItems = 0;
      
      if (!saveResponse.ok) {
        // 404 ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì¼ë¶€ ì—…ë°ì´íŠ¸ê°€ ì„±ê³µí–ˆì„ ìˆ˜ ìˆìŒ
        if (saveResponse.status === 404) {
          // 404 ì—ëŸ¬ì˜ ê²½ìš°, ì„œë²„ì—ì„œ ì¼ë¶€ ì²˜ë¦¬ë˜ì—ˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŒ
          // ê¸°ë³¸ê°’ìœ¼ë¡œ ì²˜ë¦¬
          serverProcessedItems = 0;
          skippedItems = validItems.length;
        } else {
          // ë‹¤ë¥¸ ì—ëŸ¬ì˜ ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
          const errorText = await saveResponse.text();
          let errorMessage = `HTTP error! status: ${saveResponse.status}`;
          
          if (errorText) {
            try {
              const errorData = JSON.parse(errorText);
              errorMessage += `, message: ${errorData.message || errorData.error || errorText}`;
            } catch {
              errorMessage += `, message: ${errorText}`;
            }
          }
          
          throw new Error(errorMessage);
        }
      } else {
        // ì„±ê³µí•œ ê²½ìš° ì„œë²„ ì‘ë‹µì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const saveResult = await saveResponse.json();
        serverProcessedItems = saveResult.updatedItems || 0;
        skippedItems = saveResult.skippedItems || 0;
      }
      
      // 4. ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
      let message = `O/C ëª¨ë“œ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${serverProcessedItems}ê°œ`;
      
      if (skippedItems > 0) {
        message += `\në§¤ì¹­ë˜ì§€ ì•Šì€ ì•„ì´í…œ: ${skippedItems}ê°œ (ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ)`;
      }
      
      if (invalidItemsCount > 0) {
        message += `\nìœ íš¨í•˜ì§€ ì•Šì€ ì•„ì´í…œ: ${invalidItemsCount}ê°œ (PHD/Width/Length ëˆ„ë½)`;
      }
      
      alert(message);
      
      // production.htmlë¡œ ì´ë™
      window.location.href = 'production.html';
      
    } catch (error) {
      alert("O/C ëª¨ë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }

  // ========================================
  // OIP ëª¨ë“œ Export: ìµœì í™”ëœ ë°°ì¹˜ ì²˜ë¦¬
  // ========================================
  async function saveOIPDataToOrderData() {
    try {
      
      // 1. ë°ì´í„° ì •ë¦¬ ë° ê²€ì¦
      let allItems = [];
      if (Array.isArray(globalParsedData)) {
        globalParsedData.forEach((dataArray) => {
          if (Array.isArray(dataArray)) {
            allItems = allItems.concat(dataArray);
          } else {
            allItems.push(dataArray);
          }
        });
      } else {
        allItems.push(globalParsedData);
      }
      
      
      // 2. orderNoë¡œ ì¹´í…Œê³ ë¼ì´ì¦ˆ (ë°°ì¹˜ ì²˜ë¦¬ìš©)
      const orderGroups = {};
      allItems.forEach((item) => {
        const orderNo = item.orderno;
        if (!orderGroups[orderNo]) {
          orderGroups[orderNo] = [];
        }
        orderGroups[orderNo].push(item);
      });
      
      
      // 3. ê° ì£¼ë¬¸ë³„ë¡œ ì§ì ‘ ì„œë²„ì— ë°°ì¹˜ ìš”ì²­ (ì „ì²´ ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì œê±°)
      let totalUpdated = 0;
      let totalSkipped = 0;
      let totalInvalid = 0;
      
      for (const [orderNo, items] of Object.entries(orderGroups)) {
        
        const result = await processOIPOrderOptimized(orderNo, items);
        totalUpdated += result.updatedItems;
        totalSkipped += result.skippedItems;
        totalInvalid += result.invalidItems;
      }
      
      // 4. ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
      let message = `OIP ëª¨ë“œ Export ì™„ë£Œ!\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${totalUpdated}ê°œ`;
      
      if (totalSkipped > 0) {
        message += `\në§¤ì¹­ë˜ì§€ ì•Šì€ ì•„ì´í…œ: ${totalSkipped}ê°œ`;
      }
      
      if (totalInvalid > 0) {
        message += `\nìœ íš¨í•˜ì§€ ì•Šì€ ì•„ì´í…œ: ${totalInvalid}ê°œ`;
      }
      
      alert(message);
      
      // 5. ë°ì´í„° ì´ˆê¸°í™”
      globalParsedData = [];
      document.getElementById("outputArea").value = "";
      document.getElementById("inputArea").value = "";
      
      const { orderNoInput, tfNoInput, orderDateInput } = getOrderFields();
      if (orderNoInput) orderNoInput.value = "";
      if (tfNoInput) tfNoInput.value = "";
      if (orderDateInput) orderDateInput.value = "";
      
      // production.htmlë¡œ ì´ë™
      window.location.href = 'production.html';
      
    } catch (error) {
      alert("OIP ëª¨ë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }

  // ========================================
  // OIP ëª¨ë“œ Export: ìµœì í™”ëœ ê°œë³„ ì£¼ë¬¸ ì²˜ë¦¬
  // ========================================
  async function processOIPOrderOptimized(orderNo, items) {
    try {
      
      // 0. orderData.jsonì—ì„œ í•´ë‹¹ orderNoì˜ ëª¨ë“  ì•„ì´í…œ ë¡œë“œí•˜ì—¬ .1 ë²„ì „ í™•ì¸
      let orderData = null;
      try {
        const response = await fetch('orderData.json');
        const allOrders = await response.json();
        const order = allOrders.find(o => o.orderNo === orderNo);
        if (order && order.items) {
          orderData = order.items;
        }
      } catch (error) {
      }
      
      // 1. ë°ì´í„° ê²€ì¦ ë° ì •ë¦¬, itemNo ìœ ë¬´ì— ë”°ë¼ ë‹¤ë¥¸ ë¡œì§ ì ìš©
      const validItems = [];
      const itemsWithItemNo = [];
      const itemsWithoutItemNo = [];
      
      items.forEach((item) => {
        const phd = parseFloat(item.phd);
        if (isNaN(phd) || !item.width || !item.length) {
          return; // ìœ íš¨í•˜ì§€ ì•Šì€ í•­ëª©ì€ ê±´ë„ˆë›°ê¸°
        }
        
        const itemNo = item.no || '';
        
        if (itemNo) {
          // itemNoê°€ ìˆëŠ” ê²½ìš°
          itemsWithItemNo.push(item);
        } else {
          // itemNoê°€ ì—†ëŠ” ê²½ìš°
          itemsWithoutItemNo.push(item);
        }
      });
      
      // itemNoê°€ ìˆëŠ” í•­ëª©ë“¤ ì²˜ë¦¬ (.1 ë²„ì „ í™•ì¸)
      itemsWithItemNo.forEach((item) => {
        const itemNo = item.no || '';
        let targetItemNo = itemNo;
        
        // orderDataê°€ ìˆìœ¼ë©´ .1 ë²„ì „ í™•ì¸
        if (orderData) {
          const itemNoWithDot1 = itemNo + '.1';
          const hasDot1Version = orderData.some(orderItem => orderItem.itemNo === itemNoWithDot1);
          if (hasDot1Version) {
            // .1 ë²„ì „ì´ ìˆìœ¼ë©´ .1ì— ì—…ë°ì´íŠ¸
            targetItemNo = itemNoWithDot1;
          }
        }
        
        // ì¤‘ë³µ ì œê±°
        const alreadyExists = validItems.some(vi => vi.itemNo === targetItemNo);
        if (alreadyExists) {
          return;
        }
        
        const processedItem = {
          phd: parseFloat(item.phd).toString(),
          width: item.width,
          length: item.length,
          itemNo: targetItemNo,
          w: item.w || '',
          tfkg: item.tfkg || '',
          producedkg: item.producedkg || ''
        };
        
        if (item.deliveredkg && item.deliveredkg !== '' && item.deliveredkg !== '0' && item.deliveredkg !== '0.0') {
          processedItem.deliveredkg = item.deliveredkg;
        }
        
        validItems.push(processedItem);
      });
      
      // itemNoê°€ ì—†ëŠ” í•­ëª©ë“¤ ì²˜ë¦¬ (orderDataì—ì„œ phdWidthLengthë¡œ ì°¾ì•„ì„œ itemNo ì„¤ì •)
      itemsWithoutItemNo.forEach((item) => {
        const itemPhd = parseFloat(item.phd).toString();
        const itemWidth = item.width;
        const itemLength = item.length;
        
        // orderDataì—ì„œ phdWidthLengthë¡œ ë§¤ì¹­ë˜ëŠ” í•­ëª© ì°¾ê¸°
        let matchedItemNo = null;
        if (orderData) {
          const matchedItem = orderData.find(orderItem => 
            orderItem.phd === itemPhd && 
            orderItem.width === itemWidth && 
            orderItem.length === itemLength
          );
          if (matchedItem && matchedItem.itemNo) {
            matchedItemNo = matchedItem.itemNo;
          }
        }
        
        const processedItem = {
          phd: itemPhd,
          width: itemWidth,
          length: itemLength,
          w: item.w || '',
          tfkg: item.tfkg || '',
          producedkg: item.producedkg || ''
        };
        
        // ë§¤ì¹­ëœ itemNoê°€ ìˆìœ¼ë©´ í¬í•¨
        if (matchedItemNo) {
          processedItem.itemNo = matchedItemNo;
        }
        
        if (item.deliveredkg && item.deliveredkg !== '' && item.deliveredkg !== '0' && item.deliveredkg !== '0.0') {
          processedItem.deliveredkg = item.deliveredkg;
        }
        
        validItems.push(processedItem);
      });

      const invalidItemsCount = items.length - validItems.length;
      
      if (validItems.length === 0) {
        return { updatedItems: 0, skippedItems: 0, invalidItems: invalidItemsCount };
      }

      // 2. tfNo ì¶”ì¶œ (ì²« ë²ˆì§¸ ì•„ì´í…œì˜ tfno ì‚¬ìš©)
      const tfNo = items[0].tfno;

      // 3. deliveredkgê°€ í¬í•¨ëœ ì•„ì´í…œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ itemUpdateFields ë™ì  ì„¤ì •
      const hasDeliveredkg = validItems.some(item => item.deliveredkg !== undefined);
      const itemUpdateFields = ['itemNo', 'w', 'tfkg', 'producedkg'];
      if (hasDeliveredkg) {
        itemUpdateFields.push('deliveredkg');
      }
      

      // 4. itemNoê°€ ìˆëŠ” í•­ëª©ê³¼ ì—†ëŠ” í•­ëª© ë¶„ë¦¬
      const itemsWithItemNoForUpdate = validItems.filter(item => item.itemNo);
      const itemsWithoutItemNoForUpdate = validItems.filter(item => !item.itemNo);
      
      let totalUpdated = 0;
      let totalSkipped = 0;
      
      // itemNoê°€ ìˆëŠ” í•­ëª©ë“¤ì€ itemNoë¡œ ì°¾ê¸°
      if (itemsWithItemNoForUpdate.length > 0) {
        const saveResponse = await fetch('/api/updateOrder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            searchOrderBy: 'orderNo',
            orderNo: orderNo,
            searchMethod: 'itemNo',
            updateFields: ['tfNo'],
            tfNo: tfNo,
            itemUpdateFields: itemUpdateFields,
            items: itemsWithItemNoForUpdate
          })
        });
        
        if (saveResponse.ok) {
          const saveResult = await saveResponse.json();
          totalUpdated += saveResult.updatedItems || 0;
          totalSkipped += saveResult.skippedItems || 0;
        } else if (saveResponse.status !== 404) {
          const errorText = await saveResponse.text();
          throw new Error(`HTTP error! status: ${saveResponse.status}, message: ${errorText}`);
        }
      }
      
      // itemNoê°€ ì—†ëŠ” í•­ëª©ë“¤ì€ phdWidthLengthë¡œ ì°¾ê¸°
      if (itemsWithoutItemNoForUpdate.length > 0) {
        const saveResponse = await fetch('/api/updateOrder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            searchOrderBy: 'orderNo',
            orderNo: orderNo,
            searchMethod: 'phdWidthLength',
            updateFields: ['tfNo'],
            tfNo: tfNo,
            itemUpdateFields: itemUpdateFields,
            items: itemsWithoutItemNoForUpdate
          })
        });
        
        if (saveResponse.ok) {
          const saveResult = await saveResponse.json();
          totalUpdated += saveResult.updatedItems || 0;
          totalSkipped += saveResult.skippedItems || 0;
        } else if (saveResponse.status !== 404) {
          const errorText = await saveResponse.text();
          throw new Error(`HTTP error! status: ${saveResponse.status}, message: ${errorText}`);
        }
      }
      

      const updatedItems = totalUpdated;
      const skippedItems = totalSkipped;


      return {
        updatedItems: updatedItems,
        skippedItems: skippedItems,
        invalidItems: invalidItemsCount
      };

    } catch (error) {
      throw error;
    }
  }

  // ========================================
  // ë¶„ì„í‘œ ëª¨ë“œ Export:
  // ========================================
  async function saveCModeDataToOrderData(parsedData) {
    try {
      
      if (!parsedData || parsedData.length === 0) {
        alert("ë¶„ì„í‘œ ëª¨ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      
      const data = parsedData[0];
      const orderno = data.orderno;
      const itemno = data.itemno;
      
      
      if (!orderno || !itemno) {
        alert("ë¶„ì„í‘œ ëª¨ë“œ: Order No ë˜ëŠ” Item Noê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      
      // 1. ë°ì´í„° ê²€ì¦ ë° ì •ë¦¬
      const validItem = {
        itemNo: itemno,
        producedkg: data.producedkg || ''
      };
      
      
      // 2. ì„œë²„ì— ì§ì ‘ ì—…ë°ì´íŠ¸ ìš”ì²­ (ì„œë²„ì—ì„œ ì£¼ë¬¸/ì•„ì´í…œ ì°¾ê¸° ë° ë§¤ì¹­ ì²˜ë¦¬)
      const requestData = {
        searchOrderBy: 'orderNo',
        orderNo: orderno,
        searchMethod: 'itemNo',
        itemUpdateFields: ['producedkg'],
        items: [validItem]
      };
      
      
      const saveResponse = await fetch('/api/updateOrder', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
      });
      
      let updatedItems = 0;
      let skippedItems = 0;
      
      if (!saveResponse.ok) {
        // 404 ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì¼ë¶€ ì—…ë°ì´íŠ¸ê°€ ì„±ê³µí–ˆì„ ìˆ˜ ìˆìŒ
        if (saveResponse.status === 404) {
          updatedItems = 0;
          skippedItems = 1;
        } else {
          const errorText = await saveResponse.text();
          let errorMessage = `HTTP error! status: ${saveResponse.status}`;
          
          if (errorText) {
            try {
              const errorData = JSON.parse(errorText);
              errorMessage += `, message: ${errorData.message || errorData.error || errorText}`;
            } catch {
              errorMessage += `, message: ${errorText}`;
            }
          }
          
          throw new Error(errorMessage);
        }
      } else {
        const saveResult = await saveResponse.json();
        updatedItems = saveResult.updatedItems || 0;
        skippedItems = saveResult.skippedItems || 0;
      }
      
      // 3. ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
      let message = `ë¶„ì„í‘œ ëª¨ë“œ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì—…ë°ì´íŠ¸ëœ ì•„ì´í…œ: ${updatedItems}ê°œ`;
      
      if (skippedItems > 0) {
        message += `\në§¤ì¹­ë˜ì§€ ì•Šì€ ì•„ì´í…œ: ${skippedItems}ê°œ (ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ)`;
      }
      
      alert(message);
      
      // production.htmlë¡œ ì´ë™
      window.location.href = 'production.html';
      
    } catch (error) {
      alert("ë¶„ì„í‘œ ëª¨ë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }

  // ========================================
  // Organize ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ í•¨ìˆ˜
  // ========================================
  function setupOrganizeButton() {
    const organizeBtn = document.getElementById("organizeBtn");
    if (!organizeBtn) {
      return;
    }
    
    organizeBtn.removeEventListener("click", handleOrganizeClick);
    organizeBtn.addEventListener("click", handleOrganizeClick);
  }
  
  // ========================================
  // Organize ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ - ì„ íƒëœ ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥¸ organize ë¡œì§ ì‹¤í–‰
  // ========================================
  function handleOrganizeClick() {
    
    // ì„ íƒëœ ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥¸ organize í•¨ìˆ˜ í˜¸ì¶œ
    if (selectedDoc === "O/C") {
      // O/C ëª¨ë“œ: ê¸°ì¡´ ë£°ë“¤ ì ìš© (Reels ì¬ë°°ì¹˜, PHD ì¤„ ì• ë¹ˆ ì¤„ ì¶”ê°€ ë“±)
      organizeOCMode();
    } else if (selectedDoc === "OIP") {
      // OIP ëª¨ë“œ: ì—‘ì…€ ë°ì´í„° ì—´ ì œê±° ë£° ì ìš©
      organizeOIPMode();
    } else if (selectedDoc === "C") {
      // ë¶„ì„í‘œ ëª¨ë“œ: organize ë¶ˆí•„ìš” (ë°”ë¡œ Convert ì‚¬ìš©)
      organizeCMode();
    }
  }
  
  // ========================================
  // O/C ëª¨ë“œ Organize: ê¸°ì¡´ ë£°ë“¤ ì ìš©
  // - Reels ì •ë³´ ì¬ë°°ì¹˜ (ë¯¸ì™„ì„± ì£¼ë¬¸ì— Reels ì •ë³´ ë¶™ì´ê¸°)
  // - PHD ì¤„ ì•ì— ë¹ˆ ì¤„ ì¶”ê°€
  // - ê¸°íƒ€ ë°ì´í„° ì •ë¦¬ ë£°ë“¤
  // ========================================
  function organizeOCMode() {
    const inputArea = document.getElementById("inputArea");
    const currentText = inputArea.value;
    
    if (currentText.trim() !== "") {
      // ì¤„ë°”ê¿ˆì„ ê¸°ì¤€ìœ¼ë¡œ ê° ì¤„ì„ ë¶„ë¦¬
      const lines = currentText.split('\n');
      
      // 1ë²ˆ ë£°: íŠ¹ì • í—¤ë” ë¼ì¸ë“¤ë§Œ ì‚­ì œ (ë‚˜ë¨¸ì§€ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)
      const headerLinesToRemove = [
        'ITEM PRODUCT DESCRIPTION QUANTITY',
        'UNIT',
        'DELIVERY DATE'
      ];
      
      // 2ë²ˆ ë£°: ì¶”ê°€ë¡œ ì‚­ì œí•  ë¼ì¸ë“¤
      const additionalLinesToRemove = [
        'Treatment',
        'TREATMENT OUTSIDE',
        'Packing type',
        'horizontal',
        'Country of origin',
        'Germany',
        'ELTRO KOREA CO',
        'BUSAN, KOREA',
        'MADE IN GERMANY',
        'CUSTOMER MATERIAL',
        'USD 1',
        'per',
        'KG',
        'ex plant',
        'Treofan Group',
        'Sitz der Gesellschaft: 66539 Neunkirchen/Germany Â· Handelsregister:SaarbrÃ¼cken HRA 11639 Â· KomplementÃ¤rin: Treofan Zweite Holdings GmbH,Neunkirchen;',
        // íšŒì‚¬ ì •ë³´ ì‚­ì œ
        'SUNGMOON ELECTRONICS CO., LTD',
        '61, SEGYOSANDAN-RO, PYEONGTAEK-SI',
        'GYEONGGI-DO 450-818',
        '- Amendment',
        'Invoice address Delivery address',
        'SUNGMOON ELECTRONICS CO., LTD.',
        'ATTN.: KIM, JUNG-HYUN',
        'Please replace the preceding order confirmation.',
        // ì¶”ê°€ íšŒì‚¬ ì •ë³´ ì‚­ì œ
        '61, SEGYOSANDAN-RO',
        'PYEONGTAEK-SI',
        'GYEONGGI-DO',
        'Within 90 days net from invoice date'
      ];
      
      // 2ë²ˆ ë£° ì¶”ê°€: ì •ê·œì‹ìœ¼ë¡œ ë§¤ì¹­í•  ë¼ì¸ë“¤
      const additionalPatternsToRemove = [
        /^Printed on \d{2}\.\d{2}\.\d{4} Page \d+ of \d+$/,
        /^Handelsregister: SaarbrÃ¼cken HRB \d+ Â· GeschÃ¤ftsfÃ¼hrer: .+ Â· USt-ID-Nr\.: DE \d+ \d+ \d+$/,
        /^In enquiries please quote:$/,
        /^Order number: \d+$/,
        /^Customer number: \d+$/,
        /^Order date: \d{2}\.\d{2}\.\d{4}$/,
        /^Your contact:$/,
        /^Claudia MÃ¼ller$/,
        /^Tel\.:$/,
        /^Fax:$/,
        /^email: .+@.+$/,
        /^Treofan Germany GmbH & Co\. KG Â· BergstraÃŸe Â· \d+ Neunkirchen Â· GERMANY$/,
        /^ELTRO KOREA CO\. LTD\.$/,
        /^#\d+, \d+, SONGPA-DAERO \d+-GIL$/,
        /^SONGPA-GU$/,
        /^SEOUL \d+$/,
        /^SÃœDKOREA$/,
        /^Type of order: Standard Order [A-Z]{2}$/,
        /^VAT No\. Supplier: [A-Z]{2}\d+$/,
        /^Product type: [A-Z]+$/,
        /^Order confirmation$/,
        /^\d{8}$/,
        /^We thank you for your order which we hereby accept on the basis of our General Terms and Conditions which are attached\.$/,
        /^Our General Terms and Conditions are also available on our website at: treofan\.com\/terms-a-conditions\.$/,
        /^The quality of the products is detailed in the attached Technical Specifications\.$/,
        /^Your order number: [A-Z]{2}-\d{4}-\d{2} dated \d{2}\.\d{2}\.\d{4}$/,
        /^Invoice address$/,
        /^Customer No\.: \d+$/,
        /^SOUTH KOREA$/,
        /^Delivery terms$/,
        /^Shipping type$/,
        /^Payment terms$/,
        /^CIF$/,
        /^by Sea$/,
        /^[A-Z]{2}\d{2}$/,
        /^Costs, insurance & freight, [A-Z]+$/,
        /^Payment in advance before delivery$/,
        /^\d{4}$/
      ];
      
      // 3ë²ˆ ë£°: MATERIALê³¼ ê·¸ ë‹¤ìŒ ìˆ«ì ë¼ì¸ ì‚­ì œ
      // 5ë²ˆ ë£°: Coreì™€ ê·¸ ë‹¤ìŒ ìˆ«ì+mm ë¼ì¸ ì‚­ì œ
      // 7ë²ˆ ë£°: Reels ë‹¤ìŒ 4ì¤„ ì‚­ì œ (ReelsëŠ” ìœ ì§€)
      let filteredLines = [];
      let skipNext = false;
      let skipCount = 0;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmedLine = line.trim();
        
        // MATERIAL ë¼ì¸ì¸ì§€ í™•ì¸
        if (trimmedLine.toUpperCase() === 'MATERIAL') {
          // MATERIAL ë¼ì¸ì€ ê±´ë„ˆë›°ê¸°
          skipNext = true;
          continue;
        }
        
        // MATERIAL ë‹¤ìŒ ë¼ì¸ì´ ìˆ«ìì¸ì§€ í™•ì¸
        if (skipNext && /^\d+$/.test(trimmedLine)) {
          // ìˆ«ì ë¼ì¸ë„ ê±´ë„ˆë›°ê¸°
          skipNext = false;
          continue;
        }
        
        // Core ë¼ì¸ì¸ì§€ í™•ì¸
        if (trimmedLine.toUpperCase() === 'CORE') {
          // Core ë¼ì¸ì€ ê±´ë„ˆë›°ê¸°
          skipNext = true;
          continue;
        }
        
        // Core ë‹¤ìŒ ë¼ì¸ì´ ìˆ«ì+mmì¸ì§€ í™•ì¸
        if (skipNext && /^\d+\s*mm$/i.test(trimmedLine)) {
          // ìˆ«ì+mm ë¼ì¸ë„ ê±´ë„ˆë›°ê¸°
          skipNext = false;
          continue;
        }
        
        // Reels ë¼ì¸ì¸ì§€ í™•ì¸
        if (trimmedLine.toUpperCase() === 'REELS') {
          // Reels ë¼ì¸ì€ ìœ ì§€
          filteredLines.push(line);
          
          // ë‹¤ìŒ ì¤„ì—ì„œ ì²« ë²ˆì§¸ ìˆ«ì(ë„ì–´ì“°ê¸° ì „)ë§Œ ì¶”ì¶œ
          if (i + 1 < lines.length) {
            const nextLine = lines[i + 1].trim();
            const firstNumberMatch = nextLine.match(/^([^\s]+)/);
            if (firstNumberMatch) {
              filteredLines.push(firstNumberMatch[1]);
            }
          }
          
          // ê·¸ ë‹¤ìŒ 4ì¤„ì€ ê±´ë„ˆë›°ê¸° (ì´ 5ì¤„ ì¤‘ ì²« ë²ˆì§¸ëŠ” ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ 4ì¤„ë§Œ ê±´ë„ˆë›°ê¸°)
          skipCount = 4;
          continue;
        }
        
        // Reels ë‹¤ìŒ 4ì¤„ ê±´ë„ˆë›°ê¸°
        if (skipCount > 0) {
          skipCount--;
          continue;
        }
        
        // skipNextê°€ trueì¸ë° ì¡°ê±´ì— ë§ì§€ ì•Šìœ¼ë©´ ê·¸ëƒ¥ ê±´ë„ˆë›°ê¸°
        if (skipNext) {
          skipNext = false;
          continue;
        }
        
        // 1ë²ˆ, 2ë²ˆ ë£°ì— í•´ë‹¹í•˜ëŠ” ë¼ì¸ì¸ì§€ í™•ì¸
        if (headerLinesToRemove.includes(trimmedLine) || additionalLinesToRemove.includes(trimmedLine)) {
          continue;
        }
        
        // 2ë²ˆ ë£° ì¶”ê°€: ì •ê·œì‹ íŒ¨í„´ ë§¤ì¹­
        let shouldSkip = false;
        for (const pattern of additionalPatternsToRemove) {
          if (pattern.test(trimmedLine)) {
            shouldSkip = true;
            break;
          }
        }
        if (shouldSkip) {
          continue;
        }
        
        // ë‚˜ë¨¸ì§€ëŠ” ê·¸ëŒ€ë¡œ ì¶”ê°€
        filteredLines.push(line);
      }
      
      // Reels ì •ë³´ ì¬ë°°ì¹˜ (ë¯¸ì™„ì„± ì£¼ë¬¸ì— Reels ì •ë³´ ë¶™ì´ê¸°) - ë¨¼ì € ì‹¤í–‰
      const reelsOrganizedLines = organizeReelsDistribution(filteredLines);
      
      // PHD ì¤„ ì•ì— ë¹ˆ ì¤„ ì¶”ê°€ - ë‚˜ì¤‘ì— ì‹¤í–‰
      const linesArray = reelsOrganizedLines.split('\n');
      let finalLines = [];
      for (let i = 0; i < linesArray.length; i++) {
        const line = linesArray[i];
        const trimmedLine = line.trim();
        
        // PHDê°€ í¬í•¨ëœ ì¤„ì¸ì§€ í™•ì¸
        if (trimmedLine.toUpperCase().includes('PHD')) {
          // PHD ì¤„ ì•ì— ë¹ˆ ì¤„ ì¶”ê°€ (ì´ë¯¸ ë¹ˆ ì¤„ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
          if (finalLines.length > 0 && finalLines[finalLines.length - 1].trim() !== '') {
            finalLines.push('');
          }
        }
        
        finalLines.push(line);
      }
      
      // ìµœì¢… ê²°ê³¼
      const finalResult = finalLines.join('\n');
      
      // ê²°ê³¼ë¥¼ ì…ë ¥ ì˜ì—­ì— ì„¤ì •
      inputArea.value = finalResult;
      
    }
    
    // í¬ì»¤ìŠ¤ ì„¤ì •
    inputArea.focus();
  }
  
  // Reels ì •ë³´ ì¬ë°°ì¹˜ í•¨ìˆ˜ (ìœ„ì—ì„œë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ë¯¸ì™„ì„± ì£¼ë¬¸ì— Reels ì •ë³´ ë¶™ì´ê¸°)
  function organizeReelsDistribution(lines) {
    let resultLines = [...lines];
    
    // 1ë‹¨ê³„: ëª¨ë“  Reels ì •ë³´ë¥¼ ë¯¸ë¦¬ ìˆ˜ì§‘ (ìœ„ì—ì„œë¶€í„° ìˆœì„œëŒ€ë¡œ)
    const allReelsBlocks = [];
    
    for (let i = 0; i < resultLines.length; i++) {
      const line = resultLines[i].trim();
      
      if (line.toUpperCase().includes('REELS')) {
        // ì´ Reelsê°€ ì´ë¯¸ ì£¼ë¬¸ì— ë¶™ì–´ìˆëŠ”ì§€ í™•ì¸
        let alreadyAttached = false;
        
        // ì´ Reels ë°”ë¡œ ì•ì— PHDê°€ ìˆëŠ”ì§€ í™•ì¸ (ì¦‰ì‹œ ë¶™ì–´ìˆëŠ” Reelsì¸ì§€)
        if (i > 0 && resultLines[i - 1].trim().toUpperCase().includes('PHD')) {
          // ë°”ë¡œ ì•ì— PHDê°€ ìˆìœ¼ë©´ ì´ë¯¸ ë¶™ì–´ìˆëŠ” ê²ƒ
              alreadyAttached = true;
        }
        
        // ì•„ì§ ë¶™ì§€ ì•Šì€ Reelsë¼ë©´ ìˆ˜ì§‘
        if (!alreadyAttached) {
          // REELS ë¸”ë¡ì„ 4ì¤„ ì„¸íŠ¸ë¡œ ìˆ˜ì§‘ (ìˆ˜ëŸ‰, Reels, ê°’, WK ì •ë³´)
          if (i > 0 && i < resultLines.length - 2) {
          const reelsBlock = [
              resultLines[i - 1],  // ìˆ˜ëŸ‰
              resultLines[i],      // Reels
              resultLines[i + 1],  // ê°’
              resultLines[i + 2]   // WK ì •ë³´
          ];
          allReelsBlocks.push({ index: i, block: reelsBlock });
          }
        }
      }
    }
    
    // 2ë‹¨ê³„: ëª¨ë“  Reels ë¸”ë¡ì„ ì›ë˜ ìœ„ì¹˜ì—ì„œ ì œê±° (ë’¤ì—ì„œë¶€í„° ì œê±°í•˜ì—¬ ì¸ë±ìŠ¤ ë³€í™” ë°©ì§€)
    for (let i = allReelsBlocks.length - 1; i >= 0; i--) {
      const reelsInfo = allReelsBlocks[i];
      if (reelsInfo.index > 0 && reelsInfo.index < resultLines.length - 2) {
        resultLines.splice(reelsInfo.index - 1, 4);
      }
    }
    
    // 3ë‹¨ê³„: ìœ„ì—ì„œë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ë¯¸ì™„ì„± ì£¼ë¬¸ì„ ì°¾ê³ , ìˆœì„œëŒ€ë¡œ Reels ì •ë³´ ë¶™ì´ê¸°
    let reelsBlockIndex = 0;
    
    while (reelsBlockIndex < allReelsBlocks.length) {
      // ìœ„ì—ì„œë¶€í„° ì²« ë²ˆì§¸ ë¯¸ì™„ì„± ì£¼ë¬¸ ì°¾ê¸°
      let incompleteOrderIndex = -1;
      for (let i = 0; i < resultLines.length; i++) {
        const line = resultLines[i].trim();
        if (line.toUpperCase().includes('PHD')) {
          // ì´ PHD ì£¼ë¬¸ì´ ì™„ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸ (Reels ì •ë³´ê°€ ìˆëŠ”ì§€)
          let hasReels = false;
          let nextPhdIndex = resultLines.length;
          
          // ë‹¤ìŒ PHD ìœ„ì¹˜ ì°¾ê¸°
          for (let j = i + 1; j < resultLines.length; j++) {
            if (resultLines[j].trim().toUpperCase().includes('PHD')) {
              nextPhdIndex = j;
              break;
            }
          }
          
          // ì´ PHDì™€ ë‹¤ìŒ PHD ì‚¬ì´ì— Reelsê°€ ìˆëŠ”ì§€ í™•ì¸
          for (let j = i; j < nextPhdIndex; j++) {
            if (resultLines[j].trim().toUpperCase().includes('REELS')) {
              hasReels = true;
              break;
            }
          }
          
          // ì™„ì„±ë˜ì§€ ì•Šì€ ì£¼ë¬¸ì´ë©´ ì´ê²ƒì´ ì²« ë²ˆì§¸ ë¯¸ì™„ì„± ì£¼ë¬¸
          if (!hasReels) {
            incompleteOrderIndex = i;
            break;
          }
        }
      }
      
      // ë¯¸ì™„ì„± ì£¼ë¬¸ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ
      if (incompleteOrderIndex === -1) {
        break;
      }
      
      // í˜„ì¬ ìˆœì„œì˜ Reels ë¸”ë¡ ê°€ì ¸ì˜¤ê¸°
      const currentReelsBlock = allReelsBlocks[reelsBlockIndex].block;
      
      // ë¯¸ì™„ì„± ì£¼ë¬¸ì˜ Length ë‹¤ìŒ ë‹¤ìŒ ì¤„ì— Reels ë¸”ë¡ ì‚½ì…
      let insertIndex = resultLines.length; // ê¸°ë³¸ê°’: ë§¨ ë
      
      // ì´ ë¯¸ì™„ì„± ì£¼ë¬¸ì—ì„œ Length ì°¾ê¸°
      for (let i = incompleteOrderIndex; i < resultLines.length; i++) {
        const line = resultLines[i].trim();
        if (line.toUpperCase().includes('LENGTH')) {
          // Length ë‹¤ìŒ ì¤„ì´ ê°’ì´ë¯€ë¡œ, ê·¸ ë‹¤ìŒ ë‹¤ìŒ ì¤„ì— ì‚½ì…
          insertIndex = i + 2;
          break;
        }
        // ë‹¤ìŒ PHDë¥¼ ë§Œë‚˜ë©´ ì¤‘ë‹¨
        if (i > incompleteOrderIndex && line.toUpperCase().includes('PHD')) {
          break;
        }
      }
      
      // Reels ë¸”ë¡ ì‚½ì…
      resultLines.splice(insertIndex, 0, ...currentReelsBlock);
      
      // ë‹¤ìŒ Reels ë¸”ë¡ìœ¼ë¡œ ì´ë™
      reelsBlockIndex++;
    }
    
    return resultLines.join('\n');
  }
  
  // ========================================
  // OIP ëª¨ë“œ Organize: ì—‘ì…€ ë°ì´í„° ì—´ ì œê±° ë£° ì ìš©
  // - ë¶ˆí•„ìš”í•œ ì—´ ì œê±° (A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z)
  // - ë°ì´í„° ì •ë¦¬ ë° í¬ë§·íŒ…
  // ========================================
  function organizeOIPMode() {
    const inputArea = document.getElementById("inputArea");
    const currentText = inputArea.value;
    
    if (currentText.trim() !== "") {
      // ì¤„ë°”ê¿ˆì„ ê¸°ì¤€ìœ¼ë¡œ ê° ì¤„ì„ ë¶„ë¦¬
      const lines = currentText.split('\n');
      const processedLines = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // í—¤ë” ë¼ì¸ ì‚­ì œ (Sold-to-party nameìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì¤„)
        if (line.startsWith('Sold-to-party name')) {
          continue;
        }
        
        // íƒ­ìœ¼ë¡œ êµ¬ë¶„ëœ ë°ì´í„°ì¸ì§€ í™•ì¸
        if (line.includes('\t')) {
          const columns = line.split('\t');
          
          // ìœ ì§€í•  ì—´ë“¤ë§Œ ì¶”ì¶œ (1-based ì¸ë±ìŠ¤)
          const keepColumns = [
            2,  // 2ì—´: ì£¼ë¬¸ë²ˆí˜¸
            3,  // 3ì—´: í­
            5,  // 5ì—´: PHD
            7,  // 7ì—´: TFë²ˆí˜¸
            8,  // 8ì—´: ì•„ì´í…œë²ˆí˜¸ (ë’¤ì˜ 0 ì œê±°)
            15, // 15ì—´: length
            16, // 16ì—´: tfkg
            17, // 17ì—´: producedkg
            18, // 18ì—´: deliveredkg
            21  // 21ì—´: W
          ];
          
          const processedColumns = [];
          
          for (let j = 0; j < keepColumns.length; j++) {
            const columnIndex = keepColumns[j] - 1; // 0-basedë¡œ ë³€í™˜
            
            if (columnIndex < columns.length) {
              let value = columns[columnIndex];
              
              // 8ì—´ (ì•„ì´í…œë²ˆí˜¸): ë’¤ì˜ 0 ì œê±° í›„ 4ìë¦¬ë¡œ íŒ¨ë”©
              if (j === 7) { // keepColumnsì—ì„œ 8ë²ˆì§¸ (ì¸ë±ìŠ¤ 7)
                // ë’¤ì˜ 0ë“¤ ì œê±° (ë§ˆì§€ë§‰ 0ë§Œ ì œê±°)
                value = value.replace(/0$/, '');
                if (value === '') value = '0'; // ëª¨ë“  0ì´ ì œê±°ë˜ë©´ 0ìœ¼ë¡œ ì„¤ì •
                // 4ìë¦¬ë¡œ íŒ¨ë”©
                value = value.padStart(4, '0');
              }
              
              // 17ì—´, 18ì—´: ìƒˆë¡œ ìƒì„± (ë¹ˆ ê°’)
              if (j === 10 || j === 11) { // keepColumnsì—ì„œ 17, 18ë²ˆì§¸ (ì¸ë±ìŠ¤ 10, 11)
                value = '';
              }
              
              processedColumns.push(value);
            } else {
              // ì—´ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ë¹ˆ ê°’ ì¶”ê°€
              processedColumns.push('');
            }
          }
          
          const processedLine = processedColumns.join('\t');
          processedLines.push(processedLine);
        } else {
          // íƒ­ìœ¼ë¡œ êµ¬ë¶„ë˜ì§€ ì•Šì€ ì¼ë°˜ í…ìŠ¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
          processedLines.push(line);
        }
      }
      
      // ê²°ê³¼ë¥¼ ì…ë ¥ ì˜ì—­ì— ì„¤ì •
      inputArea.value = processedLines.join('\n');
    }
    
    // í¬ì»¤ìŠ¤ ì„¤ì •
    inputArea.focus();
  }
  



  // ========================================
  // ë¶„ì„í‘œ ëª¨ë“œ Organize: í•„ìš”ì—†ìŒ
  // - ë¶„ì„í‘œ ëª¨ë“œëŠ” organize ë‹¨ê³„ê°€ ë¶ˆí•„ìš”
  // - ë°”ë¡œ Convert ë‹¨ê³„ë¡œ ì§„í–‰
  // ========================================
  function organizeCMode() {
    alert("ë¶„ì„í‘œ ëª¨ë“œëŠ” organizeê°€ í•„ìš”ì—†ìŠµë‹ˆë‹¤. ë°”ë¡œ Convertë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.");
  }

  // ì…ë ¥ê°’ ì €ì¥ í•¨ìˆ˜
  function saveInputData() {
    const inputArea = document.getElementById("inputArea");
    const { orderNoInput, tfNoInput, orderDateInput } = getOrderFields();
    
    if (inputArea && orderNoInput && tfNoInput && orderDateInput) {
      const inputData = {
        inputText: inputArea.value,
        orderNo: orderNoInput.value,
        tfNo: tfNoInput.value,
        orderDate: orderDateInput.value,
        selectedDoc: selectedDoc
      };
      
      sessionStorage.setItem("productionuploadData", JSON.stringify(inputData));
    }
  }
  
  // ì…ë ¥ê°’ ë³µì› í•¨ìˆ˜
  function restoreInputData() {
    const savedData = sessionStorage.getItem("productionuploadData");
    if (savedData) {
      try {
        const inputData = JSON.parse(savedData);
        
        const inputArea = document.getElementById("inputArea");
        const { orderNoInput, tfNoInput, orderDateInput } = getOrderFields();
        
        if (inputArea && inputData.inputText) {
          inputArea.value = inputData.inputText;
        }
        
        if (orderNoInput && inputData.orderNo) {
          orderNoInput.value = inputData.orderNo;
        }
        
        if (tfNoInput && inputData.tfNo) {
          tfNoInput.value = inputData.tfNo;
        }
        
        if (orderDateInput && inputData.orderDate) {
          orderDateInput.value = inputData.orderDate;
        }
        
        if (inputData.selectedDoc) {
          selectedDoc = inputData.selectedDoc;
          updateDocButtonStates();
        }
        
      } catch (error) {
      }
    }
  }
  
  // DOC ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
  function updateDocButtonStates() {
    const ocBtn = document.getElementById("ocBtn");
    const oipBtn = document.getElementById("oipBtn");
    const cBtn = document.getElementById("cBtn");
    
    // ëª¨ë“  ë²„íŠ¼ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
    [ocBtn, oipBtn, cBtn].forEach(btn => {
      if (btn) btn.classList.remove("selected");
    });
    
    // ì„ íƒëœ DOCì— ë”°ë¼ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
    if (selectedDoc === "O/C" && ocBtn) {
      ocBtn.classList.add("selected");
    } else if (selectedDoc === "OIP" && oipBtn) {
      oipBtn.classList.add("selected");
    } else if (selectedDoc === "C" && cBtn) {
      cBtn.classList.add("selected");
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', function() {
    // Order Noì™€ Date ì´ˆê¸°í™”
    initializeOrderFields();
    
    // ì´ˆê¸° placeholder ì„¤ì •
    updatePlaceholder();
    
    // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    setupDocButtons();
    setupConvertButton();
    setupExportButton();
    setupOrganizeButton();
    
    // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì • (O/Cê°€ ê¸°ë³¸ ì„ íƒ)
    updateDocButtonStates();
    
    // ì €ì¥ëœ ì…ë ¥ê°’ ë³µì› (ë²„íŠ¼ ìƒíƒœ ì„¤ì • í›„)
    restoreInputData();
    
    // ì…ë ¥ê°’ ë³€ê²½ ì‹œ ìë™ ì €ì¥ì„ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    const inputArea = document.getElementById("inputArea");
    const { orderNoInput, tfNoInput, orderDateInput } = getOrderFields();
    
    if (inputArea) {
      inputArea.addEventListener("input", saveInputData);
    }
    if (orderNoInput) {
      orderNoInput.addEventListener("input", saveInputData);
    }
    if (tfNoInput) {
      tfNoInput.addEventListener("input", saveInputData);
    }
    if (orderDateInput) {
      orderDateInput.addEventListener("input", saveInputData);
    }
  });
</script>
</body>
</html>
