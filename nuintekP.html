<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUINTEK Production</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #000;
      line-height: 1.5;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: -1;
    }
    .page {
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      margin: 0;
      padding-bottom: 10px;
    }
    .top-menu {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .left-menu {
      display: flex;
      gap: 3px;
    }
    .right-menu {
      display: flex;
      gap: 3px;
    }
    .top-menu-btn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
    }
    .top-menu-btn:hover {
      background: #f0f0f0;
      border-color: #999;
    }
    .top-menu-btn.mode-btn.selected {
      background: black;
      color: white;
      border-color: black;
    }
    
    /* 년도 표시 스타일 */
    .year-display {
      font-size: 0.9rem;
      font-weight: 600;
      color: #000;
      min-width: 50px;
      text-align: center;
      padding: 0 5px;
      margin: 0 3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 30px;
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
      border-radius: 3px;
    }
    
    /* 주차 표시 스타일 */
    .week-display {
      font-size: 0.9rem;
      font-weight: 600;
      color: #000;
      min-width: 50px;
      text-align: center;
      padding: 0 5px;
      margin: 0 3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 30px;
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
      border-radius: 3px;
      cursor: help;
    }
    
    .week-display:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }
    
    /* 년도 버튼 특별 스타일 */
    .year-btn {
      min-width: 30px;
      width: 30px;
      padding: 5px;
    }

    /* 주문 목록 테이블 스타일 */
    .order-table-container {
      margin-top: 20px;
      overflow-x: auto; /* 가로 스크롤 추가 */
      width: 100%;
      max-width: 100%;
      position: relative;
    }
    
    #orderTable {
      width: 100%;
      min-width: 200px; /* 13개 열 실제 너비에 맞게 조정 */
      border-collapse: collapse;
      border: 1px solid #ccc;
      font-size: 0.8rem;
      table-layout: fixed;
    }
    
    #orderTable th,
    #orderTable td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
    }
    
    /* 헤더 고정 */
    #orderTable thead th {
      position: sticky;
      top: 0;
      background-color: #f5f5f5;
      z-index: 10;
    }
    
    /* 테이블 열 너비 및 스타일 설정 */
    #orderTable th:first-child, #orderTable td:first-child { 
      width: 90px; 
      text-align: center; 
      vertical-align: middle;
      position: static;
      background-color: white;
    }
    
    #orderTable th:nth-child(2), #orderTable td:nth-child(2) { 
      width: 30px; 
      text-align: center; 
      position: static;
      background-color: white;
    }
    
    #orderTable th:nth-child(3), #orderTable td:nth-child(3) { 
      width: 40px; 
      text-align: center; 
      position: static;
      background-color: white;
    }
    
    #orderTable th:nth-child(4), #orderTable td:nth-child(4) { 
      width: 100px; 
      max-width: 100px; 
      min-width: 100px; 
      text-align: center; 
    }
    
    #orderTable th:nth-child(5), #orderTable td:nth-child(5) { 
      width: 40px; 
      max-width: 40px; 
      min-width: 40px; 
      text-align: center; 
      white-space: nowrap; 
      overflow: hidden; 
    }
    
    #orderTable th:nth-child(6), #orderTable td:nth-child(6) { 
      width: 40px; 
      max-width: 40px; 
      min-width: 40px; 
      text-align: center; 
      white-space: nowrap; 
      overflow: hidden; 
    }
    
    #orderTable th:nth-child(7), #orderTable td:nth-child(7) { 
      width: 70px; 
      max-width: 70px; 
      min-width: 70px; 
      text-align: center; 
      white-space: nowrap; 
      overflow: hidden; 
    }
    
    #orderTable th:nth-child(8), #orderTable td:nth-child(8) { 
      width: 70px; 
      max-width: 70px; 
      min-width: 70px; 
      text-align: center; 
      white-space: nowrap; 
      overflow: hidden; 
    }
    
    #orderTable th:nth-child(9), #orderTable td:nth-child(9) { 
      width: 70px; 
      max-width: 70px; 
      min-width: 70px; 
      text-align: center; 
      white-space: nowrap; 
      overflow: hidden; 
    }
    
    #orderTable th:nth-child(10), #orderTable td:nth-child(10) { 
      width: 40px; 
      max-width: 40px; 
      min-width: 40px; 
      text-align: center; 
      white-space: nowrap; 
      overflow: hidden; 
    }
    
    #orderTable th:nth-child(11), #orderTable td:nth-child(11) { 
      width: 40px; 
      max-width: 40px; 
      min-width: 40px; 
      text-align: center; 
      white-space: nowrap; 
      overflow: hidden; 
    }
    
    #orderTable th:nth-child(12), #orderTable td:nth-child(12) { 
      width: 60px; 
      max-width: 60px; 
      min-width: 60px; 
      text-align: center; 
      white-space: nowrap; 
      overflow: hidden; 
    }
    
    #orderTable th:nth-child(13), #orderTable td:nth-child(13) { 
      width: 80px; 
      max-width: 80px; 
      min-width: 80px; 
      text-align: center; 
      white-space: nowrap; 
      overflow: hidden; 
    }
    
    /* 10번째 열 체크박스 스타일 - 생산 완료 상태 (체크되지 않으면 흰색, 체크되면 파란색) */
    .row-checkbox {
      transform: scale(1.2);
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      border: 1px solid #ccc;
      border-radius: 2px;
      background-color: white; /* 기본 상태: 흰색 */
      position: relative;
    }
    
    /* 10번째 열 체크박스 체크된 상태: 파란색 */
    .row-checkbox:checked {
      background-color: #007bff;
      border-color: #007bff;
    }
    
    /* 10번째 열 체크박스 체크마크 표시 */
    .row-checkbox:checked::after {
      content: '✓';
      position: absolute;
      top: -1px;
      left: 1px;
      color: white;
      font-size: 10px;
      font-weight: bold;
    }
    
    /* 10번째 열 체크박스 cancel 상태: 흰색 배경에 검은색 X */
    .row-checkbox.cancel {
      background-color: white;
      border: 1px solid #ccc;
    }
    
    .row-checkbox.cancel::after {
      content: 'X';
      position: absolute;
      top: -1px;
      left: 1px;
      color: black;
      font-size: 10px;
      font-weight: bold;
    }
    
    /* 드롭다운 스타일 */
    .dropdown-container {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-right: auto; /* 왼쪽으로 정렬 */
    }
    
    .dropdown {
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 3px;
      background: #fff;
      font-size: 0.9rem;
      min-width: 120px;
    }
    
    .dropdown:focus {
      outline: none;
      border-color: #007bff;
    }
    
    /* 10번째 열 체크박스 호버 효과 */
    .row-checkbox:hover {
      border-color: #007bff;
    }
    
    /* 2번째 열 체크박스 스타일 - 선택/해제용 (흰색 배경 유지) */
    .itemCheckbox {
      transform: scale(1.2);
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      border: 1px solid #ccc;
      border-radius: 2px;
      background-color: white; /* 기본 상태: 흰색 */
      position: relative;
      margin: 0;
    }
    
    /* 2번째 열 체크박스 체크된 상태: 흰색 배경 유지 */
    .itemCheckbox:checked {
      background-color: white;
      border-color: #ccc;
    }
    
    /* 2번째 열 체크박스 체크마크 표시 */
    .itemCheckbox:checked::after {
      content: '✓';
      position: absolute;
      top: -1px;
      left: 1px;
      color: black;
      font-size: 10px;
      font-weight: bold;
    }
    
    /* 2번째 열 체크박스 호버 효과 */
    .itemCheckbox:hover {
      border-color: #007bff;
    }
    
    
    #orderTable th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    
    /* 고정된 셀의 배경색 보장 */
    #orderTable td:first-child {
      background-color: white;
    }
    
    /* 헤더 1, 2, 3열 강제로 연한 회색 */
    #orderTable th:nth-child(1), #orderTable th:nth-child(2), #orderTable th:nth-child(3) {
      background-color: #f5f5f5;
    }
    
    /* 1, 2, 3열 데이터 셀만 흰색 배경 (헤더는 제외) */
    #orderTable td:nth-child(1), #orderTable td:nth-child(2), #orderTable td:nth-child(3) {
      background-color: white;
    }
    
    #orderTable td {
      font-size: 0.9rem;
    }
    
    /* 하단 버튼 영역 전체 - order.html과 동일 */
    .bottom-buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 15px;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    /* 확장 손잡이 (서랍 손잡이처럼 위쪽에 튀어나옴) */
    .expand-handle {
      position: absolute;
      top: -15px;
      left: 20px;
      z-index: 10;
    }

    /* 확장/축소 버튼 */
    .expand-btn {
      font-size: 0.8rem;
      padding: 4px 12px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #f8f8f8;
      color: #666;
      border-radius: 8px 8px 0 0;
      min-width: 40px;
      height: 20px;
      line-height: 1;
      transition: all 0.2s ease;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
    }

    .expand-btn:hover {
      background: #e8e8e8;
      border-color: #999;
      box-shadow: 0 -3px 6px rgba(0,0,0,0.15);
    }

    .expand-btn.expanded {
      transform: rotate(180deg);
      background: #e0e0e0;
    }

    /* 기본 버튼 그룹 레이아웃 */
    .main-button-group {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }

    /* 상세 버튼 영역 */
    .detail-button-area {
      margin-top: 10px;
      padding: 12px;
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      animation: slideDown 0.3s ease;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .detail-button-area button {
      margin: 0;
    }

    /* 애니메이션 */
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Email 버튼 - order.html 버튼과 동일한 스타일 */
    #emailBtn {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin: 0 3px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
      color: #000;
      border-radius: 3px;
      min-width: 80px;
      height: 30px;
      line-height: 1.2;
      transition: all 0.2s ease;
    }

    #emailBtn:hover {
      background: #f0f0f0;
      border-color: #999;
    }


    /* 테이블 하단 여백 (고정 버튼과 겹치지 않도록) */
    .order-table-container {
      margin-bottom: 120px;
    }
  </style>
</head>
<body>
<div class="page">
  <h1>NUINTEK Production</h1>

  <div class="top-menu">
    <!-- 왼쪽: Home, Year, Add -->
    <div class="left-menu">
      <button type="button" onclick="location.href='nuintek.html'" class="top-menu-btn">Home</button>
      
      <!-- 년도 선택 버튼 -->
      <button type="button" id="yearDownBtn" class="top-menu-btn year-btn">▼</button>
      <span id="yearDisplay" class="year-display">2024</span>
      <button type="button" id="yearUpBtn" class="top-menu-btn year-btn">▲</button>
      
      <!-- 주차 표시 -->
      <div class="week-display" id="weekDisplay" title="">
        <span id="weekNumber">W</span>
      </div>
    </div>
    <!-- 오른쪽: NT 모드만 표시 -->
    <div class="right-menu">
      <button id="ntBtn" class="top-menu-btn mode-btn selected">NT</button>
    </div>
  </div>

  <div class="order-table-container">
    <table id="orderTable">
      <thead>
        <tr>
          <th>Order No</th>
          <th></th>
          <th>No</th>
          <th>Item</th>
          <th>주문R</th>
          <th>배송R</th>
          <th>TF KG</th>
          <th>ProducedKG</th>
          <th>DeliveredKG</th>
          <th>W</th>
            <th>생산</th>
            <th>CIF</th>
        </tr>
      </thead>
      <tbody id="orderTableBody">
        <!-- 주문 목록이 여기에 동적으로 추가됩니다 -->
      </tbody>
    </table>
  </div>
</div>

<!-- 하단 버튼 영역 - order.html과 동일한 구조 -->
<div class="bottom-buttons">
  <!-- 확장/축소 버튼 (서랍 손잡이처럼 위쪽에 튀어나옴) -->
  <div class="expand-handle">
    <button id="expandButton" type="button" class="expand-btn">▼</button>
  </div>
  
  <!-- 기본 버튼 영역 (항상 보임) -->
                <div class="main-button-group">
                    <button id="emailBtn" class="top-menu-btn">Email</button>
                </div>

  <!-- 확장 가능한 상세 버튼 영역 (기본적으로 숨김) -->
  <div id="detailButtonArea" class="detail-button-area" style="display: none;">
    <!-- 필요시 추가 버튼들 -->
  </div>
</div>

<script>
        // URL 파라미터에서 모드와 년도 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const urlMode = urlParams.get('mode');
        const urlYear = urlParams.get('year');

        // 모드 선택 버튼 (NT만)
        let currentMode = "NT"; // NT 고정
        
        // 2열 체크박스 상태를 전역으로 관리 (Email 버튼용)
        let globalCheckboxStates = new Map(); // key: "orderNo-itemNo", value: boolean
        
        // 2열 체크박스 상태 저장 함수 (Email 버튼용)
        function saveCheckboxState(orderNo, itemNo, isChecked) {
            const key = `${orderNo}-${itemNo}`;
            globalCheckboxStates.set(key, isChecked);
        }
        
        // 2열 체크박스 상태 복원 함수 (Email 버튼용)
        function restoreCheckboxStates() {
            const checkboxes = document.querySelectorAll('.itemCheckbox');
            checkboxes.forEach(checkbox => {
                const orderNo = checkbox.dataset.orderNo;
                const itemNo = checkbox.dataset.itemNo;
                const key = `${orderNo}-${itemNo}`;
                
                if (globalCheckboxStates.has(key)) {
                    checkbox.checked = globalCheckboxStates.get(key);
                }
            });
        }
        
        // 체크박스 선택/해제 함수 (간단화)
        function toggleRowSelection(checkbox) {
            const orderNo = checkbox.dataset.orderNo;
            const itemNo = checkbox.dataset.itemNo;
            const isChecked = checkbox.checked;
            
            // 2번째 열 체크박스 (itemCheckbox)인 경우
            if (checkbox.classList.contains('itemCheckbox')) {
                const key = `${orderNo}-${itemNo}`;
                globalCheckboxStates.set(key, isChecked);
            }
            
            // 10번째 열 체크박스 (row-checkbox)인 경우 - 읽기 전용이므로 아무것도 하지 않음
        }

        const ntBtn = document.getElementById("ntBtn");
        
        
        // 년도 선택 초기화
        let currentYear = urlYear ? parseInt(urlYear) : new Date().getFullYear();

        const yearDisplay = document.getElementById("yearDisplay");
        const yearUpBtn = document.getElementById("yearUpBtn");
        const yearDownBtn = document.getElementById("yearDownBtn");

        yearDisplay.textContent = currentYear;

        // 년도 증가 버튼
        yearUpBtn.addEventListener("click", async () => {
            currentYear++;
            yearDisplay.textContent = currentYear;
            await loadOrderData();
        });

        // 년도 감소 버튼
        yearDownBtn.addEventListener("click", async () => {
            if (currentYear > 2020) {
                currentYear--;
                yearDisplay.textContent = currentYear;
                await loadOrderData();
            }
        });
        
        // 서버에서 주문 데이터 로드 및 표시
        async function loadOrderData() {
            try {
                // 서버 API를 통해 주문 데이터 가져오기
                const response = await fetch('/api/orders');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const allOrders = await response.json();
                
                
                // 현재 모드와 년도에 맞는 주문 필터링
                const filteredOrders = allOrders.filter(order => {
                    // orderNo와 orderId가 모두 있는 주문만 표시 (발주 완료된 주문만)
                    if (!order.orderNo || order.orderNo.trim() === '' || !order.orderId) {
                        return false;
                    }
                    
                    // 모드 필터링 (NT만)
                    if (order.mode !== 'NT') return false;
                    
                    // 년도 필터링 (orderDate 또는 finalDate에서 년도 추출)
                    let orderYear = null;
                    
                    // orderDate에서 년도 추출 (YYYY.MM.DD 형식)
                    if (order.orderDate) {
                        orderYear = parseInt(order.orderDate.substring(0, 4));
                    }
                    
                    // finalDate에서 년도 추출 (DD-MMM-YYYY 형식)
                    if (!orderYear && order.finalDate) {
                        const parts = order.finalDate.split('-');
                        if (parts.length >= 3) {
                            orderYear = parseInt(parts[2].trim());
                        }
                    }
                    
                    return orderYear === currentYear;
                });
                
                // 각 주문의 상세 데이터(아이템 포함) 가져오기
                const ordersWithItems = await Promise.all(
                    filteredOrders.map(async (order) => {
                        try {
                            const detailResponse = await fetch(`/api/orders?orderId=${order.orderId}`);
                            
                            if (detailResponse.ok) {
                                const orderDetail = await detailResponse.json();
                                return { 
                                    ...order, 
                                    ...orderDetail  // 모든 상세 데이터 병합
                                };
                            }
                        } catch (error) {
                            console.error(`[PRODUCTION] 주문 상세 데이터 로드 오류: ${order.orderNo}`, error);
                        }
                        return { ...order, items: [] };
                    })
                );
                
                // 테이블 업데이트
                await updateOrderTable(ordersWithItems);
                
            } catch (error) {
                console.error("[PRODUCTION] 데이터 로드 실패:", error);
                await updateOrderTable([]);
            }
        }
        
        
        // 주문 테이블 업데이트 함수
        async function updateOrderTable(orders) {
            const tbody = document.getElementById('orderTableBody');
            tbody.innerHTML = '';
            
            // 현재 주문 데이터를 전역 변수에 저장
            window.currentOrders = orders;
            
            // 모든 주문 데이터도 전역으로 저장 (이메일 생성용)
            if (!window.allOrdersData) {
                window.allOrdersData = [];
            }
            
            // 현재 페이지의 주문들을 allOrdersData에 추가/업데이트
            orders.forEach(order => {
                const existingIndex = window.allOrdersData.findIndex(existingOrder => 
                    existingOrder.orderNo === order.orderNo
                );
                
                if (existingIndex !== -1) {
                    // 기존 데이터 업데이트
                    window.allOrdersData[existingIndex] = order;
                } else {
                    // 새 데이터 추가
                    window.allOrdersData.push(order);
                }
            });
            
            if (orders.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="13" style="text-align: center; color: #666;">해당 조건의 주문이 없습니다.</td>';
                tbody.appendChild(row);
                return;
            }
            
            // orderDate 기준으로 정렬 (최신이 위에)
            orders.sort((a, b) => {
                const dateA = new Date((a.orderDate || '1900-01-01').replace(/\./g, '-'));
                const dateB = new Date((b.orderDate || '1900-01-01').replace(/\./g, '-'));
                return dateB - dateA; // 최신이 위에
            });
            
            for (const order of orders) {
                
                // 각 주문의 아이템들을 처리
                if (order.items && order.items.length > 0) {
                    
                    for (const [index, item] of order.items.entries()) {
                        const row = document.createElement('tr');
                        
                        // 아이템 정보 생성: PHD-6.0(620)6x 형식
                        const itemInfo = `PHD-${item.phd}(${item.width})${item.x}`;
                        
                        // No 열 (2번째) - itemNo
                        const col2Value = item.itemNo || '';
                        
                        // 주문R 열 (4번째) - adjustment가 있으면 adjustment, 없으면 quantity
                        const col4Value = item.adjustment && String(item.adjustment).trim() !== '' ? item.adjustment : item.quantity;
                        
                        // 배송R 열 (5번째) - deliveredR
                        const col5Value = item.deliveredR || '';
                        
                        // TF KG 열 (6번째) - tfkg 값
                        const col6Value = item.tfkg || '';
                        
                        // Produced 열 (7번째) - producedkg
                        const col7Value = item.producedkg || '';
                        
                        // Delivered 열 (8번째) - deliveredkg
                        const col8Value = item.deliveredkg || '';
                        
                        // W 열 (9번째) - w 값 (주차 툴팁 포함)
                        const col9Value = item.w || '';
                        const weekTooltip = (() => {
                            if (!col9Value || !col9Value.includes('w')) return '';
                            const weekNum = parseInt(col9Value.replace('w', ''));
                            if (isNaN(weekNum) || weekNum < 1 || weekNum > 53) return '';
                            
                            // ISO 8601 표준에 따른 주차 계산
                            const year = currentYear;
                            
                            // ISO 8601: 주차를 날짜 범위로 변환
                            const simple = new Date(year, 0, 1 + (weekNum - 1) * 7);
                            const dayOfWeek = simple.getDay();
                            const ISOweekStart = new Date(simple);
                            
                            if (dayOfWeek <= 4) {
                                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
                            } else {
                                ISOweekStart.setDate(simple.getDate() + (8 - simple.getDay()));
                            }
                            
                            const ISOweekEnd = new Date(ISOweekStart);
                            ISOweekEnd.setDate(ISOweekStart.getDate() + 6);
                            
                            const formatDate = (date) => {
                                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                return `${date.getDate()}-${months[date.getMonth()]}-${date.getFullYear()}`;
                            };
                            
                            return `title="${formatDate(ISOweekStart)} ~ ${formatDate(ISOweekEnd)}"`;
                        })();
                        
                        // 생산 열 (10번째) - 체크박스 (읽기 전용, orderData.json의 isProductionComplete 값에 따라 표시)
                        const checkboxValue = `<input type="checkbox" class="row-checkbox" ${item.isProductionComplete ? 'checked' : ''} disabled>`;
                        
                        // CIF 열 (11번째) - deliveryNo가 있으면 표시, 없으면 CIF가 incheon airport인 경우만 air, 나머지는 공란
                        const col11Value = (() => {
                            // 우선순위 1: deliveryNo가 있으면 표시
                            if (item.deliveryNo && item.deliveryNo.trim() !== '') {
                                return item.deliveryNo;
                            }
                            
                            // 우선순위 2: deliveryNo가 없고 CIF가 incheon airport인 경우만 air
                            const cif = order.cif || '';
                            const cifLower = cif.toLowerCase();
                            if (cifLower.includes('incheon airport')) {
                                return 'air';
                            }
                            
                            // 나머지 경우는 공란
                            return '';
                        })();
                        
                        // 체크박스 상태 복원
                        const checkboxKey = `${order.orderNo}-${col2Value}`;
                        const isChecked = globalCheckboxStates.get(checkboxKey) ? 'checked' : '';
                        
                        // 공통 아이템 행 HTML
                        const itemRowHTML = `
                            <td><input type="checkbox" class="itemCheckbox" data-order-no="${order.orderNo}" data-item-no="${col2Value}" ${isChecked} onchange="toggleRowSelection(this)"></td>
                            <td>${col2Value}</td>
                            <td class="item-cell">${itemInfo}</td>
                            <td>${col4Value}</td>
                            <td>${col5Value}</td>
                            <td>${col6Value}</td>
                            <td>${col7Value}</td>
                            <td>${col8Value}</td>
                            <td ${weekTooltip}>${col9Value}</td>
                            <td>${checkboxValue}</td>
                            <td>${col11Value}</td>
                        `;
                        
                        if (index === 0) {
                            // 첫 번째 아이템: Order No와 아이템 행
                            const orderInfo = [
                                order.orderNo || '',
                                order.finalDate ? `(${order.finalDate})` : '',
                                order.orderId || '',
                                order.orderDate ? `(${order.orderDate})` : '',
                                order.expectedDate ? `(${order.expectedDate}월입고분)` : '',
                                order.tfNo || '',
                                order.tfDate ? `(${order.tfDate})` : ''
                            ].filter(item => item !== '').join('<br>');
                            
                            row.innerHTML = `<td rowspan="${order.items.length}" style="vertical-align: top;">${orderInfo}</td>${itemRowHTML}`;
                        } else {
                            // 나머지 아이템: 아이템 행만
                            row.innerHTML = itemRowHTML;
                        }
                        tbody.appendChild(row);
                    }
                } else {
                    // 아이템이 없는 경우
                    const orderInfo = [
                        order.orderNo || '',
                        order.finalDate ? `(${order.finalDate})` : '',
                        order.orderId || '',
                        order.orderDate ? `(${order.orderDate})` : '',
                        order.expectedDate ? `(${order.expectedDate}월입고분)` : '',
                        order.tfNo || '',
                        order.tfDate ? `(${order.tfDate})` : ''
                    ].filter(item => item !== '').join('<br>');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="vertical-align: top; text-align: center !important;">${orderInfo}</td>
                        <td style="text-align: center !important;">-</td>
                        <td style="text-align: center !important;">-</td>
                        <td class="item-cell" style="text-align: left !important;">No items</td>
                        <td style="text-align: center !important;">-</td>
                        <td style="text-align: center !important;">-</td>
                        <td style="text-align: center !important;">-</td>
                        <td style="text-align: center !important;">-</td>
                        <td style="text-align: center !important;">-</td>
                        <td style="text-align: center !important;">-</td>
                        <td style="text-align: center !important;">-</td>
                        <td style="text-align: center !important;">-</td>
                        <td style="text-align: center !important;">-</td>
                        <td style="text-align: center !important;">-</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
        }
        
        // 이메일 텍스트 생성
        async function generateEmailText() {
            // 전역 상태에서 체크된 아이템들 찾기
            const urgentItems = [];
            let itemIndex = 1;
            
            // 모든 주문 데이터를 순회하면서 체크된 아이템들 찾기
            if (window.allOrdersData) {
                window.allOrdersData.forEach(order => {
                    if (order.items) {
                        order.items.forEach(item => {
                            const key = `${order.orderNo}-${item.itemNo}`;
                            if (globalCheckboxStates.get(key)) {
                                // orderNo와 itemNo 조합
                                const itemDisplay = `${order.orderNo}-${item.itemNo}`;
                                
                                urgentItems.push(`${itemIndex}. ${itemDisplay}`);
                                itemIndex++;
                            }
                        });
                    }
                });
            }
            
            if (urgentItems.length === 0) {
                return "선택된 아이템이 없습니다.";
            }
            
            let emailText = `안녕하세요,

다음 아이템들이 긴급합니다:
${urgentItems.map(item => `\t${item}`).join('\n')}

위 아이템들의 생산 일정을 확인해 주시기 바랍니다.

감사합니다.`;
            
            return emailText;
        }
        
        // 클립보드에 텍스트 복사
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                // fallback for older browsers
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    const result = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return result;
                } catch (err) {
                    document.body.removeChild(textArea);
                    return false;
                }
            }
        }


        // Email 버튼 클릭 이벤트
        document.getElementById("emailBtn").addEventListener("click", async () => {
            try {
                const emailText = await generateEmailText();
                
                if (emailText.includes("선택된 아이템이 없습니다")) {
                    alert("선택된 아이템이 없습니다.\n\n체크박스를 선택한 후 다시 시도해주세요.");
                    return;
                }
                
                if (emailText.includes("선택된 아이템의 정보를 찾을 수 없습니다")) {
                    alert("선택된 아이템의 정보를 찾을 수 없습니다.");
                    return;
                }
                
                const success = await copyToClipboard(emailText);
                
                if (success) {
                    alert('Email 내용이 클립보드에 복사되었습니다.\n바로 붙여넣기(Ctrl+V)를 사용할 수 있습니다.');
                } else {
                    alert('클립보드 복사에 실패했습니다. 브라우저 권한을 확인해주세요.');
                }
            } catch (error) {
                console.error("이메일 텍스트 생성 중 오류:", error);
                alert("이메일 텍스트 생성 중 오류가 발생했습니다.");
            }
        });
        
        // 확장/축소 기능
        document.getElementById("expandButton").addEventListener("click", () => {
            const detailArea = document.getElementById("detailButtonArea");
            const expandBtn = document.getElementById("expandButton");
            
            if (detailArea.style.display === "none") {
                detailArea.style.display = "flex";
                expandBtn.classList.add("expanded");
                expandBtn.textContent = "▲";
            } else {
                detailArea.style.display = "none";
                expandBtn.classList.remove("expanded");
                expandBtn.textContent = "▼";
            }
        });
        
        
        // ISO 8601 표준에 따른 주차 계산 함수
        function getWeekNumber(date) {
            const targetDate = new Date(date.valueOf());
            const dayNumber = (date.getUTCDay() + 6) % 7;
            targetDate.setUTCDate(targetDate.getUTCDate() - dayNumber + 3);
            const firstThursday = targetDate.valueOf();
            targetDate.setUTCMonth(0, 1);
            if (targetDate.getUTCDay() !== 4) {
                targetDate.setUTCMonth(0, 1 + ((4 - targetDate.getUTCDay()) + 7) % 7);
            }
            return 1 + Math.ceil((firstThursday - targetDate) / 604800000);
        }
        
        // 주차 표시 업데이트 함수
        function updateWeekDisplay() {
            const now = new Date();
            const weekNumber = getWeekNumber(now);
            const year = now.getFullYear();
            const dateStr = now.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            
            const weekDisplay = document.getElementById('weekDisplay');
            const weekNumberSpan = document.getElementById('weekNumber');
            
            weekNumberSpan.textContent = `W${weekNumber}`;
            weekDisplay.title = `${dateStr} (${year}년 ${weekNumber}주차)`;
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            // 주차 표시 업데이트
            updateWeekDisplay();
            
            // 초기 데이터 로드
            loadOrderData();
        });
        

</script>
</body>
</html>
